{% extends 'hadith_app/base.html' %}

{% block title %}الملف الشخصي - {{ user.get_full_name|default:user.username }}{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .profile-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border-radius: 1.5rem;
        padding: 2.5rem 2rem;
        color: white;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .profile-header::before {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 50%;
        z-index: 1;
    }

    .profile-header::after {
        content: '';
        position: absolute;
        bottom: -100px;
        left: -50px;
        width: 250px;
        height: 250px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        z-index: 1;
    }

    .profile-info {
        display: flex;
        align-items: center;
        gap: 2.5rem;
        position: relative;
        z-index: 2;
        flex-wrap: wrap;
    }

    .profile-avatar {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        border: 4px solid rgba(255, 255, 255, 0.3);
        object-fit: cover;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3.5rem;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .profile-avatar-initials {
        font-weight: 700;
        text-transform: uppercase;
    }

    .profile-avatar-edit {
        position: absolute;
        bottom: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.6);
        width: 100%;
        text-align: center;
        padding: 0.5rem;
        font-size: 0.9rem;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .profile-avatar:hover .profile-avatar-edit {
        opacity: 1;
    }

    .profile-details {
        flex: 1;
        min-width: 250px;
    }

    .profile-details h1 {
        margin: 0 0 0.5rem;
        font-size: 2.2rem;
        font-weight: 700;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .profile-username {
        display: inline-block;
        background: rgba(255, 255, 255, 0.15);
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .profile-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin: 0.5rem 0;
    }

    .profile-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        opacity: 0.9;
    }

    .profile-meta-item i {
        font-size: 1.1rem;
    }

    .profile-stats {
        display: flex;
        gap: 2.5rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .stat-item {
        text-align: center;
        min-width: 80px;
    }

    .stat-number {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.85rem;
        opacity: 0.9;
        color: rgba(255, 255, 255, 0.9);
    }

    .profile-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .btn-profile {
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
        font-size: 0.95rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Profile Tabs */
    .profile-tabs {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .profile-tabs .nav-tabs {
        border: none;
        padding: 0 1.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    
    .profile-tabs .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
        padding: 1.25rem 1.5rem;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .profile-tabs .nav-tabs .nav-link i {
        margin-left: 0.5rem;
        font-size: 1.1em;
    }
    
    .profile-tabs .nav-tabs .nav-link:hover {
        color: #4f46e5;
        border-color: transparent;
    }
    
    .profile-tabs .nav-tabs .nav-link.active {
        color: #4f46e5;
        background: transparent;
        border-color: transparent;
        border-bottom-color: #4f46e5;
    }
    
    .empty-state {
        padding: 2rem;
    }
    
    .empty-state i {
        color: #dee2e6;
        margin-bottom: 1rem;
    }
    
    .empty-state h5 {
        color: #343a40;
        margin-bottom: 0.5rem;
    }
    
    /* Settings Form */
    .settings-form .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .settings-form .form-control {
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        border: 1px solid #e9ecef;
        transition: all 0.2s ease;
    }
    
    .settings-form .form-control:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.1);
    }
    
    /* Responsive Adjustments */
    @media (max-width: 767.98px) {
        .profile-header {
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .profile-info {
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .profile-details {
            text-align: center;
        }
        
        .profile-stats {
            justify-content: center;
        }
        
        .profile-actions {
            justify-content: center;
        }
        
        .profile-tabs .nav-tabs {
            overflow-x: auto;
            flex-wrap: nowrap;
            padding-bottom: 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .profile-tabs .nav-tabs .nav-link {
            white-space: nowrap;
            padding: 1rem;
        }
    }
    
    /* Dark Mode */
    [data-bs-theme="dark"] .profile-tabs {
        background-color: #1e293b;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    [data-bs-theme="dark"] .profile-tabs .nav-tabs {
        background-color: #0f172a;
        border-bottom-color: #2d3748;
    }
    
    [data-bs-theme="dark"] .profile-tabs .nav-link {
        color: #94a3b8;
    }
    
    [data-bs-theme="dark"] .profile-tabs .nav-link.active {
        color: #818cf8;
        border-bottom-color: #818cf8;
    }
    
    [data-bs-theme="dark"] .empty-state h5 {
        color: #f8fafc;
    }
    
    [data-bs-theme="dark"] .empty-state p {
        color: #94a3b8;
    }
    
    [data-bs-theme="dark"] .settings-form .form-label {
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .settings-form .form-control {
        background-color: #1e293b;
        border-color: #2d3748;
        color: #e2e8f0;
    }
    
    [data-bs-theme="dark"] .settings-form .form-control:focus {
        border-color: #818cf8;
        box-shadow: 0 0 0 0.25rem rgba(129, 140, 248, 0.1);
    }

    .btn-profile-primary {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .btn-profile-primary:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
    }

    .profile-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .profile-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow);
        height: fit-content;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--text-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: var(--text-light);
    }

    .info-value {
        color: var(--text-dark);
        font-weight: 500;
    }

    .activity-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-color);
    }

    .activity-details {
        flex: 1;
    }

    .activity-title {
        font-weight: 600;
        color: var(--text-dark);
        margin: 0;
    }

    .activity-time {
        font-size: 0.875rem;
        color: var(--text-light);
        margin: 0;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .badge-scholar {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
    }

    .badge-member {
        background: var(--bg-light);
        color: var(--text-dark);
    }

    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--text-light);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Dark theme adjustments */
    [data-theme="dark"] .profile-section {
        background: #2d3748;
    }

    [data-theme="dark"] .activity-icon {
        background: #4a5568;
    }

    [data-theme="dark"] .badge-member {
        background: #4a5568;
        color: var(--text-dark);
    }

    @media (max-width: 768px) {
        .profile-info {
            flex-direction: column;
            text-align: center;
            gap: 1.5rem;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            font-size: 2.5rem;
        }

        .profile-details h1 {
            font-size: 2rem;
        }

        .profile-stats {
            justify-content: center;
        }

        .profile-actions {
            justify-content: center;
            flex-wrap: wrap;
        }

        .profile-content {
            grid-template-columns: 1fr;
        }

        .profile-header {
            padding: 2rem 1.5rem;
        }

        .profile-section {
            padding: 1.5rem;
        }
    }

    /* Form Styles */
    .form-control, .form-select {
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
        background-color: #fff;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.15);
    }
    
    /* Avatar Upload */
    .avatar-upload-wrapper {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .avatar-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        overflow: hidden;
        border: 3px solid #f1f5f9;
    }
    
    .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Form Labels */
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #1e293b;
    }
    
    /* Form Text */
    .form-text {
        font-size: 0.875rem;
        color: #64748b;
    }
    
    /* Error States */
    .is-invalid {
        border-color: #ef4444 !important;
    }
    
    .invalid-feedback {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="profile-info">
            <div class="profile-avatar">
                {% if profile.avatar %}
                    <img src="{{ profile.avatar.url }}" alt="{{ user.get_full_name }}">
                {% else %}
                    <div class="profile-avatar-initials">
                        {{ user.get_full_name|slice:":2"|default:user.username|slice:":2" }}
                    </div>
                {% endif %}
                <div class="profile-avatar-edit">
                    <i class="fas fa-camera"></i> تغيير
                </div>
            </div>
            
            <div class="profile-details">
                <h1>{{ user.get_full_name|default:user.username }}</h1>
                <div class="profile-username">@{{ user.username }}</div>
                
                <div class="profile-meta">
                    <div class="profile-meta-item">
                        <i class="fas fa-envelope"></i>
                        <span>{{ user.email }}</span>
                    </div>
                    {% if profile.phone %}
                    <div class="profile-meta-item">
                        <i class="fas fa-phone"></i>
                        <span>{{ profile.phone }}</span>
                    </div>
                    {% endif %}
                    {% if profile.location %}
                    <div class="profile-meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ profile.location }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <span class="stat-number">{{ user.hadiths.count|default:0 }}</span>
                        <span class="stat-label">الأحاديث</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ user.followers.count|default:0 }}</span>
                        <span class="stat-label">المتابِعون</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ user.following.count|default:0 }}</span>
                        <span class="stat-label">المتابَعون</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">{{ user.bookmarks.count|default:0 }}</span>
                        <span class="stat-label">المحفوظات</span>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <a href="{% url 'hadith_app:profile_settings' %}" class="btn-profile btn-profile-primary">
                        <i class="fas fa-edit"></i> تعديل الملف الشخصي
                    </a>
                    <a href="{% url 'password_change' %}" class="btn-profile btn-profile-secondary">
                        <i class="fas fa-key"></i> تغيير كلمة المرور
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Profile Tabs -->
    <div class="profile-tabs">
        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="activity-tab" data-bs-toggle="tab" 
                        data-bs-target="#activity" type="button" role="tab" aria-controls="activity" 
                        aria-selected="true">
                    <i class="fas fa-stream me-2"></i> النشاطات
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="hadiths-tab" data-bs-toggle="tab" 
                        data-bs-target="#hadiths" type="button" role="tab" aria-controls="hadiths" 
                        aria-selected="false">
                    <i class="fas fa-book me-2"></i> أحاديثي
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bookmarks-tab" data-bs-toggle="tab" 
                        data-bs-target="#bookmarks" type="button" role="tab" aria-controls="bookmarks" 
                        aria-selected="false">
                    <i class="fas fa-bookmark me-2"></i> المحفوظات
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" 
                        data-bs-target="#settings" type="button" role="tab" aria-controls="settings" 
                        aria-selected="false">
                    <i class="fas fa-cog me-2"></i> الإعدادات
                </button>
            </li>
        </ul>
        
        <div class="tab-content p-4 bg-white rounded-bottom" id="profileTabsContent">
            <!-- Activity Tab -->
            <div class="tab-pane fade show active" id="activity" role="tabpanel" aria-labelledby="activity-tab">
                <div class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-stream fa-3x text-muted mb-3"></i>
                        <h5>لا توجد أنشطة بعد</h5>
                        <p class="text-muted">سيظهر نشاطك هنا عند تفاعلك مع المنصة</p>
                        <a href="{% url 'hadith_app:hadith_list' %}" class="btn btn-primary mt-3">
                            <i class="fas fa-book-open me-2"></i> تصفح الأحاديث
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Hadiths Tab -->
            <div class="tab-pane fade" id="hadiths" role="tabpanel" aria-labelledby="hadiths-tab">
                <div class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-book fa-3x text-muted mb-3"></i>
                        <h5>لا توجد أحاديث مضافة</h5>
                        <p class="text-muted">يمكنك إضافة أحاديث جديدة من خلال الضغط على الزر أدناه</p>
                        <a href="{% url 'hadith_app:hadith_add' %}" class="btn btn-primary mt-3">
                            <i class="fas fa-plus me-2"></i> إضافة حديث جديد
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Bookmarks Tab -->
            <div class="tab-pane fade" id="bookmarks" role="tabpanel" aria-labelledby="bookmarks-tab">
                <div class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                        <h5>لا توجد محفوظات</h5>
                        <p class="text-muted">احفظ الأحاديث المفضلة لديك للرجوع إليها لاحقاً</p>
                        <a href="{% url 'hadith_app:hadith_list' %}" class="btn btn-primary mt-3">
                            <i class="fas fa-book-open me-2"></i> تصفح الأحاديث
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="row">
                    <div class="col-lg-6">
                        <h5 class="mb-4">
                            <i class="fas fa-user-cog me-2"></i> الإعدادات الشخصية
                        </h5>
                        <form method="post" enctype="multipart/form-data" id="profileForm">
                            {% csrf_token %}
                            
                            <!-- Avatar Upload -->
                            <div class="mb-4">
                                <div class="avatar-upload-wrapper">
                                    <div class="avatar-preview">
                                        {% if profile.avatar %}
                                            <img id="avatarPreview" src="{{ profile.avatar.url }}" alt="{{ user.get_full_name }}">
                                        {% else %}
                                            <div id="avatarPreview" class="bg-light d-flex align-items-center justify-content-center h-100">
                                                <i class="fas fa-user fa-3x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <label for="id_avatar" class="form-label">صورة الملف الشخصي</label>
                                        <input type="file" class="form-control" id="id_avatar" name="avatar" accept="image/*">
                                        <div class="form-text">يُسمح بالصور بحجم أقل من 2 ميجابايت</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Form Fields -->
                            {% for field in form %}
                                {% if field.name != 'avatar' %}  <!-- Skip avatar field as we handle it separately -->
                                    <div class="mb-3">
                                        <label for="{{ field.id_for_label }}" class="form-label">
                                            {{ field.label }}
                                            {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        {{ field }}
                                        {% if field.help_text %}
                                            <div class="form-text">{{ field.help_text }}</div>
                                        {% endif %}
                                        {% if field.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ field.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                            
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="fas fa-save me-2"></i> حفظ التغييرات
                                </button>
                                <a href="{% url 'password_change' %}" class="text-decoration-none">
                                    <i class="fas fa-key me-1"></i> تغيير كلمة المرور
                                </a>
                            </div>
                        </form>
                        
                        <script>
                            // Handle avatar preview
                            document.getElementById('id_avatar').addEventListener('change', function(e) {
                                const file = e.target.files[0];
                                if (file) {
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        let preview = document.getElementById('avatarPreview');
                                        if (preview.querySelector('img')) {
                                            preview.querySelector('img').src = e.target.result;
                                        } else {
                                            preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                                        }
                                    }
                                    reader.readAsDataURL(file);
                                }
                            });
                            
                            // Add Bootstrap validation
                            (function() {
                                'use strict';
                                var form = document.getElementById('profileForm');
                                form.addEventListener('submit', function(event) {
                                    if (!form.checkValidity()) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                    }
                                    form.classList.add('was-validated');
                                }, false);
                            })();
                        </script>
                    </div>
                    <div class="col-lg-6">
                        <h5 class="mb-4">
                            <i class="fas fa-shield-alt me-2"></i> الأمان
                        </h5>
                        
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h6>جلسات الدخول النشطة</h6>
                                <p class="text-muted small mb-3">يمكنك تسجيل الخروج من جميع الأجهزة الأخرى</p>
                                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#logoutAllSessionsModal">
                                    <i class="fas fa-sign-out-alt me-2"></i> تسجيل الخروج من جميع الأجهزة
                                </button>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6>حذف الحساب</h6>
                                <p class="text-muted small mb-3">سيتم حذف جميع بياناتك بشكل دائم ولا يمكن استرجاعها</p>
                                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                    <i class="fas fa-trash-alt me-2"></i> حذف الحساب
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logout All Sessions Modal -->
<div class="modal fade" id="logoutAllSessionsModal" tabindex="-1" aria-labelledby="logoutAllSessionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logoutAllSessionsModalLabel">تأكيد تسجيل الخروج</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>هل أنت متأكد من رغبتك في تسجيل الخروج من جميع الأجهزة؟ ستحتاج إلى تسجيل الدخول مرة أخرى.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <form action="{% url 'hadith_app:logout_all_sessions' %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">تأكيد تسجيل الخروج</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger" id="deleteAccountModalLabel">تأكيد حذف الحساب</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>تحذير:</strong> سيتم حذف حسابك وبياناتك بشكل دائم ولا يمكن استرجاعها.
                </div>
                <p>للتأكيد، يرجى كتابة <strong>حذف حسابي</strong> في الحقل أدناه:</p>
                <input type="text" class="form-control mb-3" id="confirmDeleteText" placeholder="اكتب 'حذف حسابي' هنا">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <form method="post" action="{% url 'hadith_app:delete_account' %}" id="deleteAccountForm">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                        <i class="fas fa-trash-alt me-2"></i> حذف الحساب نهائياً
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Enable/disable delete account button based on confirmation text
    document.getElementById('confirmDeleteText').addEventListener('input', function(e) {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.disabled = e.target.value.trim() !== 'حذف حسابي';
    });
    
    // Handle delete account form submission
    document.getElementById('deleteAccountForm').addEventListener('submit', function(e) {
        if (!confirm('هل أنت متأكد من أنك تريد حذف حسابك بشكل دائم؟ لا يمكن التراجع عن هذا الإجراء.')) {
            e.preventDefault();
            return false;
        }
        // Show loading state
        const btn = document.getElementById('confirmDeleteBtn');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> جاري الحذف...';
        btn.disabled = true;
    });
</script>

    <!-- Profile Content -->
    <div class="profile-content">
        <!-- Personal Information -->
        <div class="profile-section">
            <h3 class="section-title">
                <i class="bi bi-person"></i>
                المعلومات الشخصية
            </h3>
            
            <div class="info-item">
                <span class="info-label">اسم المستخدم</span>
                <span class="info-value">{{ user.username }}</span>
            </div>
            
            <div class="info-item">
                <span class="info-label">الاسم الكامل</span>
                <span class="info-value">{{ user.get_full_name|default:"غير محدد" }}</span>
            </div>
            
            <div class="info-item">
                <span class="info-label">البريد الإلكتروني</span>
                <span class="info-value">{{ user.email }}</span>
            </div>
            
            {% if profile.phone_number %}
            <div class="info-item">
                <span class="info-label">رقم الهاتف</span>
                <span class="info-value">{{ profile.phone_number }}</span>
            </div>
            {% endif %}
            
            {% if profile.birth_date %}
            <div class="info-item">
                <span class="info-label">تاريخ الميلاد</span>
                <span class="info-value">{{ profile.birth_date|date:"d F Y" }}</span>
            </div>
            {% endif %}
            
            {% if profile.specialization %}
            <div class="info-item">
                <span class="info-label">التخصص</span>
                <span class="info-value">{{ profile.specialization }}</span>
            </div>
            {% endif %}
            
            <div class="info-item">
                <span class="info-label">تاريخ الانضمام</span>
                <span class="info-value">{{ user.date_joined|date:"d F Y" }}</span>
            </div>
            
            {% if profile.bio %}
            <div class="mt-3">
                <h5 class="info-label">نبذة شخصية</h5>
                <p class="info-value mt-2">{{ profile.bio }}</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Recent Activity -->
        <div class="profile-section">
            <h3 class="section-title">
                <i class="bi bi-clock-history"></i>
                الأنشطة الأخيرة
            </h3>
            
            {% if recent_activities %}
                {% for activity in recent_activities %}
                <div class="activity-item">
                    <div class="activity-icon">
                        {% if activity.activity_type == 'login' %}
                            <i class="bi bi-box-arrow-in-right"></i>
                        {% elif activity.activity_type == 'logout' %}
                            <i class="bi bi-box-arrow-right"></i>
                        {% elif activity.activity_type == 'view_hadith' %}
                            <i class="bi bi-eye"></i>
                        {% elif activity.activity_type == 'search' %}
                            <i class="bi bi-search"></i>
                        {% elif activity.activity_type == 'profile_update' %}
                            <i class="bi bi-person-gear"></i>
                        {% else %}
                            <i class="bi bi-activity"></i>
                        {% endif %}
                    </div>
                    
                    <div class="activity-details">
                        <p class="activity-title">{{ activity.get_activity_type_display }}</p>
                        {% if activity.description %}
                            <p class="activity-time">{{ activity.description }}</p>
                        {% endif %}
                        <p class="activity-time">{{ activity.timestamp|timesince }} مضت</p>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-clock-history"></i>
                    <p>لا توجد أنشطة حديثة</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Handle theme switching
    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const theme = this.getAttribute('data-theme');
            document.documentElement.setAttribute('data-bs-theme', theme);
            
            // Save theme preference
            fetch('{% url "set_theme" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({theme: theme})
            });
            
            // Update active state
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Profile avatar preview
    const avatarInput = document.getElementById('id_avatar');
    const avatarPreview = document.querySelector('.profile-avatar img');
    const avatarInitials = document.querySelector('.profile-avatar-initials');
    
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (avatarPreview) {
                        avatarPreview.src = e.target.result;
                        avatarPreview.style.display = 'block';
                    }
                    if (avatarInitials) {
                        avatarInitials.style.display = 'none';
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Handle tab state in URL
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    
    if (activeTab) {
        const tabElement = document.getElementById(`${activeTab}-tab`);
        if (tabElement) {
            const tab = new bootstrap.Tab(tabElement);
            tab.show();
        }
    }
    
    // Update URL when tab changes
    const tabElms = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabElms.forEach(tabEl => {
        tabEl.addEventListener('shown.bs.tab', function (event) {
            const tabId = event.target.getAttribute('id').replace('-tab', '');
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            window.history.pushState({}, '', url);
        });
    });
    
    // Initialize form validation
    (function() {
        'use strict';
        
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        const forms = document.querySelectorAll('.needs-validation');
        
        // Loop over them and prevent submission
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                form.classList.add('was-validated');
            }, false);
        });
    })();
    
    // Handle profile stats animation
    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }
    
    // Animate stats when they come into view
    const observerOptions = {
        threshold: 0.5
    };
    
    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const statNumber = entry.target.querySelector('.stat-number');
                const target = parseInt(statNumber.textContent, 10);
                statNumber.textContent = '0';
                animateValue(statNumber, 0, target, 2000);
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);
    
    // Observe all stat items
    document.querySelectorAll('.stat-item').forEach(statItem => {
        observer.observe(statItem);
    });
    
    // Handle image upload preview
    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const preview = input.closest('.profile-avatar-container').querySelector('.profile-avatar');
                const initials = preview.querySelector('.profile-avatar-initials');
                const img = preview.querySelector('img');
                
                if (img) {
                    img.src = e.target.result;
                } else {
                    const newImg = document.createElement('img');
                    newImg.src = e.target.result;
                    newImg.alt = 'صورة الملف الشخصي';
                    newImg.className = 'w-100 h-100';
                    preview.prepend(newImg);
                }
                
                if (initials) {
                    initials.style.display = 'none';
                }
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    // Initialize image upload for avatar
    const avatarUpload = document.querySelector('.profile-avatar-upload');
    if (avatarUpload) {
        avatarUpload.addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function() {
                handleImageUpload(this);
                // You can add AJAX upload here if needed
            });
            
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        });
    }
</script>
{% endblock %}

{% extends "library/base.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<!-- PDF.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';</script>
<style>
    .pdf-page-container {
        position: relative;
        display: inline-block;
        margin: 0 auto;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        background: #fff;
        max-width: 100%;
    }
    
    .page-number-overlay {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.9em;
        pointer-events: none;
        z-index: 10;
    }
    
    .pdf-viewer-container {
        position: relative;
        min-height: 600px;
        display: flex;
        flex-direction: column;
        background: #525659;
        padding: 20px 0;
    }
    
    .pdf-toolbar {
        background-color: #f8f9fa;
        padding: 8px 15px;
        border-radius: 4px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .page-loading-progress {
        font-weight: bold;
    }
    
    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
    
    .loading-pulse {
        animation: pulse 1.5s infinite ease-in-out;
    }
    
    #pdf-viewer {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 600px;
        background: #525659;
        position: relative;
    }
    
    .pdf-page {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 0 auto;
    }
    
    .loading-container {
        text-align: center;
        color: white;
    }
    
    .error-message {
        color: #dc3545;
        background: #f8d7da;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
    }
</style>

<div class="document-detail">
    <div class="document-header">
        <h1>{{ document.title }}</h1>
        <div class="document-meta">
            <span class="meta-item">
                <strong>{% trans 'Type:' %}</strong> {{ document.get_file_type_display }}
            </span>
            {% if document.category %}
            <span class="meta-item">
                <strong>{% trans 'Category:' %}</strong> 
                <a href="{% url 'library:document_category' document.category.id %}">{{ document.category.name }}</a>
            </span>
            {% endif %}
            <span class="meta-item">
                <strong>{% trans 'Uploaded by:' %}</strong> {{ document.uploaded_by.get_full_name|default:document.uploaded_by.username }}
            </span>
            <span class="meta-item">
                <strong>{% trans 'Uploaded on:' %}</strong> {{ document.created_at|date:"F j, Y" }}
            </span>
        </div>
        
        <div class="document-actions">
            <a href="{% url 'library:document_download' document.pk %}" class="button">
                <span class="icon">‚Üì</span> {% trans 'Download' %}
            </a>
            {% if document.uploaded_by == user or user.is_staff %}
            <a href="{% url 'admin:library_document_change' document.pk %}" class="button">
                <span class="icon">‚úèÔ∏è</span> {% trans 'Edit' %}
            </a>
            <a href="{% url 'library:document_delete' document.pk %}" class="button">
                <span class="icon">üóëÔ∏è</span> {% trans 'Delete' %}
            </a>
            <button id="extract-hadiths-btn" class="button" data-document-id="{{ document.id }}">
                <span class="icon">üìú</span> {% trans 'Extract Hadiths' %}
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Extraction Progress Modal -->
    <div id="extraction-progress-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>{% trans 'Extracting Hadiths...' %}</h3>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%;"></div>
                </div>
                <div class="progress-text">0%</div>
            </div>
            <div class="progress-message">{% trans 'Starting extraction process...' %}</div>
            <div class="progress-details">
                <div class="progress-detail">
                    <span class="detail-label">{% trans 'Status:' %}</span>
                    <span class="detail-value" id="status-text">{% trans 'Initializing...' %}</span>
                </div>
                <div class="progress-detail">
                    <span class="detail-label">{% trans 'Page:' %}</span>
                    <span class="detail-value" id="page-text">-</span>
                </div>
                <div class="progress-detail">
                    <span class="detail-label">{% trans 'Extracted:' %}</span>
                    <span class="detail-value" id="extracted-text">0</span>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancel-extraction" class="button button-secondary">{% trans 'Cancel' %}</button>
            </div>
        </div>
    </div>
    
    <!-- Hadith Extraction Results -->
    <div id="hadith-results" class="mt-4" style="display: none;">
        <h3>{% trans 'Extracted Hadiths' %}</h3>
        <div id="hadith-list" class="mt-3">
            <!-- Results will be populated by JavaScript -->
        </div>
    </div>
    
    {% if document.description %}
    <div class="document-description">
        <h3>{% trans 'Description' %}</h3>
        <p>{{ document.description|linebreaksbr }}</p>
    </div>
    {% endif %}
    
    <div class="document-preview">
        <h3>{% trans 'Preview' %}</h3>
        {% if document.file_type == 'pdf' %}
        <div class="pdf-viewer-container">
            <div class="pdf-toolbar d-flex justify-content-between align-items-center mb-2">
                <div class="btn-group">
                    <button id="prev-page" class="btn btn-sm btn-outline-secondary" disabled>
                        <i class="fas fa-arrow-left"></i> {% trans 'Previous' %}
                    </button>
                    <span class="px-3 py-1">
                        <span id="page-num">1</span> / <span id="page-count">1</span>
                    </span>
                    <button id="next-page" class="btn btn-sm btn-outline-secondary" disabled>
                        {% trans 'Next' %} <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                <div class="btn-group">
                    <button id="zoom-out" class="btn btn-sm btn-outline-secondary" title="{% trans 'Zoom Out' %}">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button id="zoom-in" class="btn btn-sm btn-outline-secondary" title="{% trans 'Zoom In' %}">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <a href="{{ document.file.url }}" class="btn btn-sm btn-primary" download>
                        <i class="fas fa-download"></i> {% trans 'Download' %}
                    </a>
                </div>
            </div>
            
            <div id="pdf-viewer" class="border rounded bg-light" style="min-height: 600px; display: flex; justify-content: center; align-items: center;">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans 'Loading...' %}</span>
                    </div>
                    <p class="mt-2">{% trans 'Loading document preview...' %}</p>
                </div>
            </div>
        </div>
        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('pdf-viewer');
            const pageNumEl = document.getElementById('page-num');
            const pageCountEl = document.getElementById('page-count');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const zoomInBtn = document.getElementById('zoom-in');
            const zoomOutBtn = document.getElementById('zoom-out');
            
            let pdfDoc = null;
            let currentPage = 1;
            let totalPages = 1;
            let zoom = 1.0;
            let isRendering = false;
            let pageRendering = false;
            let pageNumPending = null;
            
            // Show loading state
            function showLoading() {
                container.innerHTML = `
                    <div class="text-center p-5 w-100">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">{% trans 'Loading...' %}</span>
                        </div>
                        <p class="mt-2">{% trans 'Loading document preview...' %}</p>
                    </div>`;
            }
            
            // Show error state
            function showError(message) {
                container.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        ${message || 'Failed to load document preview'}
                    </div>`;
            }
            
            // Initialize PDF.js
            function initPdfViewer() {
                showLoading();
                
                // Configure PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
                
                // Load the PDF
                const loadingTask = pdfjsLib.getDocument({
                    url: "{{ document.file.url }}",
                    withCredentials: true
                });
                
                loadingTask.promise.then(function(pdf) {
                    pdfDoc = pdf;
                    totalPages = pdf.numPages;
                    pageCountEl.textContent = totalPages;
                    
                    // Enable/disable buttons
                    if (prevBtn) prevBtn.disabled = true;
                    if (nextBtn) nextBtn.disabled = totalPages <= 1;
                    if (zoomInBtn) zoomInBtn.disabled = false;
                    if (zoomOutBtn) zoomOutBtn.disabled = false;
                    
                    // Render the first page
                    renderPage(1);
                }).catch(function(error) {
                    console.error('Error loading PDF:', error);
                    let errorMessage = 'Error loading document preview.';
                    if (error && error.message) {
                        errorMessage += ' ' + error.message;
                    }
                    showError(errorMessage);
                    
                    // Disable all controls on error
                    if (prevBtn) prevBtn.disabled = true;
                    if (nextBtn) nextBtn.disabled = true;
                    if (zoomInBtn) zoomInBtn.disabled = true;
                    if (zoomOutBtn) zoomOutBtn.disabled = true;
                });
            }
            
            // Render the specified page
            function renderPage(num) {
                if (pageRendering) {
                    pageNumPending = num;
                    return;
                }
                
                pageRendering = true;
                
                // Show loading state
                container.innerHTML = `
                    <div class="loading-container">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading page ${num}...</span>
                        </div>
                        <p class="mt-2">Loading page ${num} of ${totalPages}</p>
                    </div>
                `;
                
                // Fetch the page
                pdfDoc.getPage(num).then(function(page) {
                    const viewport = page.getViewport({ scale: zoom });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    
                    // Set canvas dimensions
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    // Create page container
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    
                    // Add page number overlay
                    const pageNumber = document.createElement('div');
                    pageNumber.className = 'page-number-overlay';
                    pageNumber.textContent = `Page ${num} of ${totalPages}`;
                    
                    // Render PDF page into canvas context
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    
                    const renderTask = page.render(renderContext);
                    
                    renderTask.promise.then(function() {
                        // Clear container and add rendered page
                        container.innerHTML = '';
                        pageContainer.appendChild(canvas);
                        pageContainer.appendChild(pageNumber);
                        container.appendChild(pageContainer);
                        
                        // Update page number display
                        pageNumEl.textContent = num;
                        
                        // Update buttons
                        prevBtn.disabled = num <= 1;
                        nextBtn.disabled = num >= totalPages;
                        
                        pageRendering = false;
                        
                        // Render next pending page if any
                        if (pageNumPending !== null) {
                            renderPage(pageNumPending);
                            pageNumPending = null;
                        }
                    });
                    
                }).catch(function(error) {
                    console.error('Error rendering page:', error);
                    showError('Error rendering page. Please try again.');
                    pageRendering = false;
                });
            }
            
            // Show error message
            function showError(message) {
                container.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                `;
            }
            
            // Navigation functions
            function goToPrevPage() {
                if (currentPage <= 1 || pageRendering) return;
                currentPage--;
                renderPage(currentPage);
            }
            
            function goToNextPage() {
                if (currentPage >= totalPages || pageRendering) return;
                currentPage++;
                renderPage(currentPage);
            }
            
            function zoomIn() {
                if (zoom >= 2.0) return;
                zoom += 0.25;
                renderPage(currentPage);
            }
            
            function zoomOut() {
                if (zoom <= 0.5) return;
                zoom -= 0.25;
                renderPage(currentPage);
            }
            
            // Event listeners
            if (prevBtn) prevBtn.addEventListener('click', goToPrevPage);
            if (nextBtn) nextBtn.addEventListener('click', goToNextPage);
            if (zoomInBtn) zoomInBtn.addEventListener('click', zoomIn);
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', zoomOut);
            
            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft') {
                    goToPrevPage();
                } else if (e.key === 'ArrowRight') {
                    goToNextPage();
                } else if (e.key === '+' || e.key === '=') {
                    zoomIn();
                    e.preventDefault();
                } else if (e.key === '-' || e.key === '_') {
                    zoomOut();
                    e.preventDefault();
                }
            });
            
            // Initialize PDF viewer
            initPdfViewer();
            
            // Function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Add event listeners for keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowLeft' && currentPage > 1) {
                    goToPrevPage();
                } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
                    goToNextPage();
                } else if (e.key === '+' || e.key === '=') {
                    zoomIn();
                    e.preventDefault();
                } else if (e.key === '-' || e.key === '_') {
                    zoomOut();
                    e.preventDefault();
                }
            });
            
            // Navigation handlers
            function goToPrevPage() {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage(currentPage);
                }
            }
            
            function goToNextPage() {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPage(currentPage);
                }
            }
            
            // Zoom handlers
            function zoomIn() {
                if (zoom < 3.0) {
                    zoom += 0.25;
                    renderPage(currentPage);
                }
            }
            
            function zoomOut() {
                if (zoom > 0.5) {
                    zoom -= 0.25;
                    renderPage(currentPage);
                }
            }
            
            // Add button event listeners
            if (prevBtn) prevBtn.addEventListener('click', goToPrevPage);
            if (nextBtn) nextBtn.addEventListener('click', goToNextPage);
            if (zoomInBtn) zoomInBtn.addEventListener('click', zoomIn);
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', zoomOut);
            
            // Load the first page
            loadPage(0);  
        });
        
        }); // Close the PDF viewer DOMContentLoaded
        
        // Handle hadith extraction with progress tracking
        document.addEventListener('DOMContentLoaded', function() {
            const extractBtn = document.getElementById('extract-hadiths-btn');
            const progressModal = document.getElementById('extraction-progress-modal');
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');
            const progressMessage = document.querySelector('.progress-message');
            const statusText = document.getElementById('status-text');
            const pageText = document.getElementById('page-text');
            const extractedText = document.getElementById('extracted-text');
            let currentTaskId = null;
            let progressCheckInterval = null;
            
            // Initialize extraction button
            if (extractBtn) {
                extractBtn.addEventListener('click', function() {
                    startExtraction();
                });
            }
            
            // Initialize cancel button
            const cancelBtn = document.getElementById('cancel-extraction');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    cancelExtraction();
                });
            }
            
            // Show the progress modal
            function showProgressModal() {
                if (progressModal) {
                    progressModal.style.display = 'block';
                    resetProgress();
                }
            }
            
            // Hide the progress modal
            function hideProgressModal() {
                if (progressModal) {
                    progressModal.style.display = 'none';
                }
                if (progressCheckInterval) {
                    clearInterval(progressCheckInterval);
                    progressCheckInterval = null;
                }
            }
            
            // Reset progress indicators
            function resetProgress() {
                if (progressFill) progressFill.style.width = '0%';
                if (progressText) progressText.textContent = '0%';
                if (progressMessage) progressMessage.textContent = '{% trans "Starting extraction process..." %}';
                if (statusText) statusText.textContent = '{% trans "Initializing..." %}';
                if (pageText) pageText.textContent = '-';
                if (extractedText) extractedText.textContent = '0';
            }
            
            // Update progress bar and text
            function updateProgress(progress, message, details = {}) {
                const percent = Math.min(100, Math.max(0, parseInt(progress) || 0));
                if (progressFill) progressFill.style.width = `${percent}%`;
                if (progressText) progressText.textContent = `${percent}%`;
                if (progressMessage) progressMessage.textContent = message;
                
                // Update status text with additional details if provided
                let statusMessage = message;
                if (details.current_page && details.total_pages) {
                    statusMessage += ` (Page ${details.current_page} of ${details.total_pages})`;
                }
                if (details.extracted_count !== undefined) {
                    statusMessage += ` - Extracted: ${details.extracted_count}`;
                }
                
                if (statusText) statusText.textContent = statusMessage;
                
                // Update page number if available
                if (pageText && details.current_page) {
                    pageText.textContent = details.current_page;
                }
                
                // Update extracted count if available
                if (extractedText && details.extracted_count !== undefined) {
                    extractedText.textContent = details.extracted_count;
                }
            }
            
            // Check extraction progress
            function checkProgress(taskId) {
                fetch(`{% url 'library:check_extraction_progress' 'TASK_ID' %}`.replace('TASK_ID', taskId))
                    .then(response => response.json())
                    .then(data => {
                        if (data.success === false && data.error) {
                            // Error occurred
                            updateProgress(100, `Error: ${data.error}`, { status: 'Error' });
                            if (progressCheckInterval) {
                                clearInterval(progressCheckInterval);
                                progressCheckInterval = null;
                            }
                            return;
                        }
                        
                        // Update progress
                        updateProgress(
                            data.progress || 0,
                            data.message || 'Processing...',
                            {
                                status: data.status || 'Processing',
                                current_page: data.current_page,
                                total_pages: data.total_pages,
                                total_hadiths: data.total_hadiths || 0
                            }
                        );
                        
                        // If completed or failed, stop checking
                        if (data.status === 'completed' || data.status === 'failed') {
                            if (progressCheckInterval) {
                                clearInterval(progressCheckInterval);
                                progressCheckInterval = null;
                                
                                // If completed, reload the page to show results
                                if (data.status === 'completed') {
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking progress:', error);
                        updateProgress(100, 'Error checking progress', { status: 'Error' });
                    });
            }
            
            // Cancel extraction
            function cancelExtraction() {
                if (confirm('Are you sure you want to cancel the extraction?')) {
                    if (progressCheckInterval) {
                        clearInterval(progressCheckInterval);
                        progressCheckInterval = null;
                    }
                    hideProgressModal();
                    btn.disabled = false;
                    
                    // TODO: Implement cancellation on the server side
                    if (currentTaskId) {
                        console.log('Cancellation requested for task:', currentTaskId);
                    }
                }
            };
        });
        
        {% elif document.file_type == 'docx' %}
        <div class="document-notice alert alert-info">
            <p class="mb-3">{% trans 'Word documents cannot be previewed in the browser. Please download the file to view it.' %}</p>
            <a href="{% url 'library:document_download' document.pk %}" class="btn btn-primary" download>
                <i class="fas fa-download"></i> {% trans 'Download Document' %}
            </a>
        </div>
        {% else %}
        <div class="document-notice alert alert-warning">
            <p class="mb-3">{% trans 'This file type cannot be previewed. Please download the file to view it.' %}</p>
            <a href="{% url 'library:document_download' document.pk %}" class="btn btn-primary" download>
                <i class="fas fa-download"></i> {% trans 'Download File' %}
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% extends 'pdf_reader/pdf_reader_base.html' %}
{% load static i18n %}

{% block title %}{{ document.title }} - {% trans 'عرض المستند' %}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --toolbar-height: 56px;
        --page-margin: 20px;
        --controls-bg: #f8f9fa;
        --border-color: #dee2e6;
        --primary-color: #0d6efd;
        --hover-color: #0b5ed7;
    }
    
    body {
        overflow: hidden;
        margin: 0;
        padding: 0;
        height: 100vh;
    }
    
    .pdf-viewer-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #525659;
        position: relative;
    }
    
    .pdf-viewer-toolbar {
        padding: 0.5rem 1rem;
        background-color: var(--controls-bg);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        height: var(--toolbar-height);
        z-index: 10;
        gap: 1rem;
    }
    
    .pdf-viewer-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 30%;
        direction: rtl;
        text-align: right;
        padding: 0 0.5rem;
    }
    
    .pdf-viewer-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .pdf-viewer-content {
        flex: 1;
        position: relative;
        overflow: auto;
        background-color: #525659;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 1rem 0;
    }
    
    .pdf-page-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }
    
    .pdf-viewer-page {
        max-width: 100%;
        max-height: 100%;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        background-color: white;
        margin: 0 auto;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        display: none;
    }
    
    .loading-overlay.show {
        display: flex;
    }
    
    .loading-content {
        color: white;
        text-align: center;
    }
    
    .page-indicator {
        min-width: 80px;
        text-align: center;
    }
    
    @media (max-width: 768px) {
        .pdf-viewer-toolbar {
            flex-wrap: wrap;
            height: auto;
            padding: 0.5rem;
        }
        
        .pdf-viewer-title {
            order: -1;
            max-width: 100%;
            text-align: center;
            padding: 0.5rem 0;
        }
        
        .pdf-viewer-actions {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .btn-group {
            margin: 0.25rem 0;
        }
    }
    
    .pdf-viewer-content {
        flex: 1;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: var(--page-margin);
        position: relative;
        background-color: #525659;
    }
    
    .pdf-viewer-page {
        background-color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        margin: 0 auto;
        max-width: 100%;
        transition: transform 0.2s ease;
    }
    
    .pdf-viewer-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .page-navigation {
        display: flex;
        align-items: center;
        margin: 0 0.5rem;
    }
    
    .page-indicator {
        margin: 0 0.75rem;
        min-width: 80px;
        text-align: center;
        font-family: monospace;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(2px);
    }
    
    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .zoom-controls {
        display: flex;
        align-items: center;
        margin-right: 1rem;
    }
    
    .zoom-btn {
        background: white;
        border: 1px solid var(--border-color);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        user-select: none;
    }
    
    .zoom-btn:first-child {
        border-radius: 4px 0 0 4px;
    }
    
    .zoom-btn:last-child {
        border-radius: 0 4px 4px 0;
    }
    
    .zoom-btn:not(:last-child) {
        border-right: none;
    }
    
    .zoom-btn:hover {
        background-color: #f1f1f1;
    }
    
    .zoom-level {
        padding: 0 0.75rem;
        min-width: 60px;
        text-align: center;
    }
    
    @media (max-width: 768px) {
        .pdf-viewer-toolbar {
            flex-wrap: wrap;
            height: auto;
            padding: 0.5rem;
        }
        
        .pdf-viewer-title {
            order: 1;
            max-width: 100%;
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .pdf-viewer-actions {
            order: 2;
            width: 100%;
            justify-content: center;
            margin-top: 0.5rem;
        }
        
        .zoom-controls {
            margin-right: 0;
            margin-left: 0.5rem;
        }
        
        .pdf-viewer-actions {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-group {
            margin: 0.25rem 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pdf-viewer-container" dir="rtl" 
     data-document-id="{{ document.id }}"
     data-total-pages="{{ total_pages|default:1 }}"
     data-current-page="{{ page|default:1 }}"
     data-zoom-level="{{ zoom_level|default:1.0 }}"
     data-document-title="{{ document.title|escapejs }}"
     data-document-url="{{ document.file.url }}"
     data-base-url="{% url 'pdf_reader:document_viewer' pk=document.pk %}"
     data-document-detail-url="{% url 'pdf_reader:document_detail' pk=document.pk %}"
     data-can-download="{% if can_download %}true{% else %}false{% endif %}" 
     data-can-edit="{% if can_edit %}true{% else %}false{% endif %}">
    <div class="pdf-viewer-toolbar">
        <div class="d-flex align-items-center me-auto">
            <a href="{% url 'pdf_reader:document_detail' pk=document.pk %}" class="btn btn-outline-secondary btn-sm me-2" title="{% trans 'العودة إلى تفاصيل المستند' %}">
                <i class="fas fa-arrow-right me-1"></i> {% trans 'العودة' %}
            </a>
            <a href="{% url 'pdf_reader:document_download' document.pk %}" 
               class="btn btn-outline-primary btn-sm me-2"
               download
               title="{% trans 'تحميل الملف' %}">
                <i class="fas fa-download"></i>
            </a>
            <h1 class="pdf-viewer-title mb-0" title="{{ document.title }}">
                {{ document.title|truncatechars:60 }}
            </h1>
        </div>
        <div class="pdf-viewer-actions">
            <div class="btn-group me-2">
                <button id="prev-page" class="btn btn-outline-secondary" title="{% trans 'الصفحة السابقة' %}">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <span class="page-indicator px-2 d-flex align-items-center">
                    <span id="page-num">1</span> / <span id="page-count">{{ total_pages|default:1 }}</span>
                </span>
                <button id="next-page" class="btn btn-outline-secondary" title="{% trans 'الصفحة التالية' %}">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <div class="btn-group me-2">
                <button id="zoom-out" class="btn btn-outline-secondary" title="{% trans 'تصغير' %}">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button class="btn btn-outline-secondary px-3" disabled>
                    <span id="zoom-level">150%</span>
                </button>
                <button id="zoom-in" class="btn btn-outline-secondary" title="{% trans 'تكبير' %}">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>
            
            <div class="btn-group">
                <a href="{% url 'pdf_reader:document_download' document.pk %}" class="btn btn-outline-primary" title="{% trans 'تحميل' %}">
                    <i class="fas fa-download"></i>
                </a>
                {% if can_edit %}
                <a href="{% url 'pdf_reader:document_update' document.pk %}" class="btn btn-outline-secondary" title="{% trans 'تعديل' %}">
                    <i class="fas fa-edit"></i>
                </a>
                {% endif %}
                <button id="debug-btn" class="btn btn-outline-warning" title="{% trans 'تصحيح الأخطاء' %}">
                    <i class="fas fa-bug"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="pdf-viewer-content">
        <div id="loading-overlay" class="loading-overlay d-flex align-items-center justify-content-center">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">{% trans 'جاري التحميل...' %}</span>
                </div>
                <p class="mb-0" id="loading-text">{% trans 'جاري تحميل المستند، الرجاء الانتظار...' %}</p>
            </div>
        </div>
        
        <div class="pdf-page-container">
            <img id="pdf-page" class="pdf-viewer-page" alt="{% trans 'صفحة المستند' %}" style="display: none;">
        </div>
        
        <div id="error-message" class="alert alert-danger m-3" style="display: none; position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%) translateY(20px); max-width: 90%; width: auto; min-width: 300px; max-width: 600px; text-align: right; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25); z-index: 9999; opacity: 0; transition: all 0.3s ease-in-out; backdrop-filter: blur(5px); border-left: 4px solid #ff8a9c;">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-circle me-2 mt-1"></i>
                <div>
                    <div id="error-text"></div>
                    <div class="mt-2 small" id="error-details" style="display: none; background-color: rgba(0, 0, 0, 0.1); padding: 8px 12px; border-radius: 4px; font-family: monospace; direction: ltr; text-align: left; max-height: 200px; overflow-y: auto;"></div>
                    <div class="mt-2" id="error-actions"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function(window, document) {
        'use strict';
        
        // Get container element with all data attributes
        const container = document.querySelector('.pdf-viewer-container');
        
        // Initialize variables from data attributes
        let currentPage = parseInt(container.getAttribute('data-current-page')) || 1;
        let totalPages = parseInt(container.getAttribute('data-total-pages')) || 1;
        let currentZoom = parseFloat(container.getAttribute('data-zoom-level')) || 1.5;
        const documentId = container.getAttribute('data-document-id');
        const documentTitle = container.getAttribute('data-document-title');
        const documentUrl = container.getAttribute('data-document-url');
        const baseUrl = container.getAttribute('data-base-url');
        const documentDetailUrl = container.getAttribute('data-document-detail-url');
        const canDownload = container.getAttribute('data-can-download') === 'true';
        const canEdit = container.getAttribute('data-can-edit') === 'true';
        
        // DOM Elements
        const pdfPage = document.getElementById('pdf-page');
        const pageContainer = document.querySelector('.pdf-page-container');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageNumInput = document.getElementById('page-num');
        const pageCountElement = document.getElementById('page-count');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomLevelEl = document.getElementById('zoom-level');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const errorEl = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // Configuration
        const ZOOM_LEVELS = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0];
        const DEFAULT_ZOOM_LEVEL = 1.5;
        const ZOOM_STEP = 0.25;
        const MIN_ZOOM = 0.5;
        const MAX_ZOOM = 3.0;
        
        // State
        let isLoading = false;
        
        // Debug function to log all elements
        function debugElements() {
            console.log('=== Debugging PDF Viewer ===');
            console.log('Container:', container);
            console.log('PDF Page Element:', pdfPage);
            console.log('Page Container:', pageContainer);
            console.log('Loading Overlay:', loadingOverlay);
            console.log('Error Element:', errorEl);
            console.log('Document ID:', documentId);
            console.log('Current Page:', currentPage);
            console.log('Total Pages:', totalPages);
            console.log('Current Zoom:', currentZoom);
            console.log('===========================');
        }

        // Debug function to log all network requests
        function logNetworkRequest(url, options) {
            console.log('Network Request:', {
                url,
                method: options?.method || 'GET',
                headers: options?.headers,
                credentials: options?.credentials,
                timestamp: new Date().toISOString()
            });
            
            // Log when the request starts
            const startTime = Date.now();
            console.log(`Starting request to ${url}`);
            
            return {
                end: (response) => {
                    const duration = Date.now() - startTime;
                    console.log(`Request to ${url} completed in ${duration}ms`, {
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries([...response.headers.entries()]),
                        response: response
                    });
                    return response;
                },
                error: (error) => {
                    const duration = Date.now() - startTime;
                    console.error(`Request to ${url} failed after ${duration}ms`, error);
                    throw error;
                }
            };
        }

        // Track if the viewer is already initialized
        let isViewerInitialized = false;
        
        // Initialize the viewer when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Prevent multiple initializations
            if (isViewerInitialized) {
                console.log('Viewer already initialized, skipping...');
                return;
            }
            
            console.log('DOM Content Loaded - Initializing PDF Viewer');
            
            if (!documentId) {
                const errorMsg = 'معرف المستند غير صالح. يرجى التحقق من الرابط والمحاولة مرة أخرى.';
                console.error(errorMsg);
                showError(errorMsg);
                return;
            }

            try {
                // Debug elements
                debugElements();
                
                // Verify required elements exist
                if (!pdfPage) {
                    throw new Error('عنصر صفحة PDF غير موجود');
                }
                
                if (!pageContainer) {
                    throw new Error('حاوية الصفحة غير موجودة');
                }
                
                // Mark as initialized
                isViewerInitialized = true;
                
                // Set document title
                document.title = (documentTitle || 'مستند') + ' - ' + '{% trans "عرض المستند" %}';
                
                // Set initial page count display
                if (pageCountElement) {
                    pageCountElement.textContent = totalPages;
                } else {
                    console.warn('عنصر عداد الصفحات غير موجود');
                }
                
                // Set current page in the input
                if (pageNumInput) {
                    pageNumInput.value = currentPage;
                } else {
                    console.warn('حقل إدخال رقم الصفحة غير موجود');
                }
                
                // Set up event listeners
                setupEventListeners();
                
                // Set initial zoom level display
                updateZoomDisplay();
                
                // Initial button state update
                updateButtonStates();
                
                console.log('Loading initial page...');
                
                // Focus the container for keyboard events
                container.focus();
                
                // Load the first page only if not already loaded
                if (currentPage >= 1 && currentPage <= totalPages) {
                    loadPage(currentPage, currentZoom);
                }
                
                console.log('PDF viewer initialized successfully');
            } catch (error) {
                console.error('Error initializing PDF viewer:', error);
                const errorMsg = `حدث خطأ أثناء تهيئة عارض المستندات: ${error.message || 'خطأ غير معروف'}`;
                showError(errorMsg);
            }
        });
        
        /**
         * Set up event listeners
         */
        // Store references to event listeners for cleanup
        const eventListeners = {
            prevBtn: null,
            nextBtn: null,
            zoomInBtn: null,
            zoomOutBtn: null,
            pageNumInput: null,
            pageNumBlur: null,
            keydown: null,
            resize: null
        };
        
        function setupEventListeners() {
            // Remove any existing event listeners first
            if (eventListeners.prevBtn && prevBtn) {
                prevBtn.removeEventListener('click', eventListeners.prevBtn);
            }
            if (eventListeners.nextBtn && nextBtn) {
                nextBtn.removeEventListener('click', eventListeners.nextBtn);
            }
            if (eventListeners.zoomInBtn && zoomInBtn) {
                zoomInBtn.removeEventListener('click', eventListeners.zoomInBtn);
            }
            if (eventListeners.zoomOutBtn && zoomOutBtn) {
                zoomOutBtn.removeEventListener('click', eventListeners.zoomOutBtn);
            }
            if (eventListeners.pageNumInput && pageNumInput) {
                pageNumInput.removeEventListener('keydown', eventListeners.pageNumInput);
            }
            if (eventListeners.pageNumBlur && pageNumInput) {
                pageNumInput.removeEventListener('blur', eventListeners.pageNumBlur);
            }
            if (eventListeners.keydown) {
                document.removeEventListener('keydown', eventListeners.keydown);
            }
            if (eventListeners.resize) {
                window.removeEventListener('resize', eventListeners.resize);
            }
            
            // Navigation buttons
            if (prevBtn) {
                eventListeners.prevBtn = goToPrevPage;
                prevBtn.addEventListener('click', eventListeners.prevBtn);
            }
            
            if (nextBtn) {
                eventListeners.nextBtn = goToNextPage;
                nextBtn.addEventListener('click', eventListeners.nextBtn);
            }
            
            // Zoom buttons
            if (zoomInBtn) {
                eventListeners.zoomInBtn = zoomIn;
                zoomInBtn.addEventListener('click', eventListeners.zoomInBtn);
            }
            
            if (zoomOutBtn) {
                eventListeners.zoomOutBtn = zoomOut;
                zoomOutBtn.addEventListener('click', eventListeners.zoomOutBtn);
            }
            
            // Page number input (if it's an input element)
            if (pageNumInput && pageNumInput.tagName === 'INPUT') {
                const handlePageInput = function(e) {
                    if (e.key === 'Enter') {
                        const pageNum = parseInt(this.value);
                        if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= totalPages) {
                            loadPage(pageNum);
                        } else {
                            this.value = currentPage;
                        }
                    }
                };
                
                const handlePageBlur = function() {
                    const pageNum = parseInt(this.value);
                    if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
                        this.value = currentPage;
                    }
                };
                
                eventListeners.pageNumInput = handlePageInput;
                eventListeners.pageNumBlur = handlePageBlur;
                
                pageNumInput.addEventListener('keydown', handlePageInput);
                pageNumInput.addEventListener('blur', handlePageBlur);
            }
            
            // Handle keyboard navigation
            eventListeners.keydown = handleKeyDown;
            document.addEventListener('keydown', eventListeners.keydown);
            
            // Handle window resize with debounce
            let resizeTimer;
            const handleResizeWithDebounce = function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    handleResize();
                }, 250);
            };
            
            eventListeners.resize = handleResizeWithDebounce;
            window.addEventListener('resize', handleResizeWithDebounce);
        }
        
        /**
         * Load a specific page with optional zoom level
         */
        async function loadPage(pageNum, zoomLevel = null) {
            console.log(`loadPage called with pageNum: ${pageNum}, zoomLevel: ${zoomLevel}`);
            
            if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
                const errorMsg = `رقم الصفحة غير صالح: ${pageNum} (يجب أن يكون بين 1 و ${totalPages})`;
                console.error(errorMsg);
                showError(errorMsg);
                return;
            }
            
            // Update current page
            currentPage = pageNum;
            
            // Update zoom if provided
            if (zoomLevel !== null) {
                currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoomLevel));
                console.log(`Zoom level set to: ${currentZoom}`);
            }
            
            // Show loading state
            const loadingMsg = `جاري تحميل الصفحة ${pageNum} من ${totalPages}...`;
            console.log(loadingMsg);
            showLoading(loadingMsg);
            
            // Clear any previous errors
            hideError();
            
            // Ensure we have a valid document ID
            if (!documentId) {
                const errorMsg = 'معرف المستند غير صالح';
                console.error(errorMsg);
                showError(errorMsg);
                hideLoading();
                return;
            }
            
            try {
                // Construct the URL for the page image using the correct URL pattern
                const url = `{% url 'pdf_reader:document_viewer_page' 0 0 %}`.replace('/0/viewer/page/0/', `/${documentId}/viewer/page/${pageNum}/`) + `?zoom=${currentZoom}`;
                
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const cacheBustingUrl = `${url}${url.includes('?') ? '&' : '?'}_=${timestamp}`;
                
                console.log('Fetching page from:', cacheBustingUrl);
                
                // Log the request
                const requestLog = logNetworkRequest(cacheBustingUrl, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json, image/*',
                    },
                    credentials: 'same-origin',
                    cache: 'no-store'  // Prevent caching
                });
                
                // First, try to fetch the page as an image
                let response;
                try {
                    response = await fetch(cacheBustingUrl, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json, image/*',
                        },
                        credentials: 'same-origin',
                        cache: 'no-store'  // Prevent caching
                    });
                    
                    // Log the response
                    response = requestLog.end(response.clone());
                    
                    // Check for network errors
                    if (!response) {
                        throw new Error('لا يوجد استجابة من الخادم');
                    }
                    
                } catch (networkError) {
                    console.error('Network error during fetch:', networkError);
                    throw new Error('فشل الاتصال بالخادم. يرجى التحقق من اتصال الشبكة والمحاولة مرة أخرى.');
                }

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries([...response.headers.entries()]));
                
                // Log response for debugging
                const responseClone = response.clone();
                const responseText = await responseClone.text().catch(e => 'Unable to read response text');
                console.log('Response text (first 500 chars):', responseText.substring(0, 500));

                // Handle non-200 responses
                if (!response.ok) {
                    let errorMessage = 'فشل تحميل الصفحة';
                    let errorDetails = '';
                    
                    try {
                        // Try to parse as JSON first
                        try {
                            const errorData = await response.json();
                            console.error('Error response (JSON):', errorData);
                            errorMessage = errorData.message || errorMessage;
                            errorDetails = errorData.details || '';
                        } catch (jsonError) {
                            // If not JSON, try to get text
                            const errorText = await response.text();
                            console.error('Error response (text):', errorText);
                            errorMessage = errorText || errorMessage;
                        }
                        
                        // Add status code information
                        errorMessage = `[${response.status} ${response.statusText}] ${errorMessage}`;
                        
                    } catch (e) {
                        console.error('Error handling error response:', e);
                        errorMessage = `خطأ في معالجة الاستجابة: ${e.message || 'خطأ غير معروف'}`;
                    }
                    
                    // Special handling for common status codes
                    if (response.status === 403) {
                        errorMessage = 'ليس لديك صلاحية لعرض هذا المستند';
                    } else if (response.status === 404) {
                        errorMessage = 'لم يتم العثور على المستند المطلوب';
                    } else if (response.status >= 500) {
                        errorMessage = 'حدث خطأ في الخادم. يرجى المحاولة مرة أخرى لاحقًا.';
                    }
                    
                    throw new Error(errorMessage + (errorDetails ? `\n${errorDetails}` : ''));
                }

                // Check if the response is a redirect
                const contentType = response.headers.get('content-type') || '';
                console.log('Content-Type:', contentType);

                if (contentType.includes('application/json')) {
                    try {
                        const data = await response.json();
                        console.log('JSON response:', data);
                        
                        if (data.redirect_url) {
                            console.log('Redirecting to:', data.redirect_url);
                            window.location.href = data.redirect_url;
                            return;
                        }
                        
                        // Handle other JSON responses
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        throw new Error(data.message || 'استجابة غير متوقعة من الخادم');
                        
                    } catch (jsonError) {
                        console.error('Error parsing JSON response:', jsonError);
                        throw new Error('خطأ في معالجة استجابة الخادم');
                    }
                }

                // Verify we have an image response
                if (!contentType || !contentType.includes('image/')) {
                    console.error('Unexpected content type:', contentType);
                    console.error('Response headers:', Object.fromEntries([...response.headers.entries()]));
                    
                    // Try to get response text for debugging
                    try {
                        const responseText = await response.text();
                        console.error('Unexpected response content:', responseText.substring(0, 500));
                    } catch (e) {
                        console.error('Could not read response content:', e);
                    }
                    
                    throw new Error('نوع الملف غير مدعوم. يرجى التأكد من أن الملف المطلوب موجود وصالح.');
                }

                // If we get here, it's an image response
                const blob = await response.blob();
                console.log('Received blob:', {type: blob.type, size: blob.size});
                
                if (blob.size === 0) {
                    throw new Error('تم استلام ملف فارغ من الخادم');
                }

                const imageUrl = URL.createObjectURL(blob);
                
                // Create a new image element
                const img = new Image();
                
                // Set up error handler for the image
                img.onerror = function() {
                    console.error('Failed to load image from blob URL');
                    showError('فشل تحميل الصورة. يرجى المحاولة مرة أخرى.');
                    hideLoading();
                };
                
                // Set up the image load handler
                img.onload = function() {
                    console.log(`Page ${pageNum} loaded successfully`);
                    
                    // Update the existing image element
                    if (pdfPage.src && pdfPage.src.startsWith('blob:')) {
                        URL.revokeObjectURL(pdfPage.src); // Clean up previous blob URL
                    }
                    
                    pdfPage.onerror = null;
                    pdfPage.onload = null;
                    
                    pdfPage.src = imageUrl;
                    pdfPage.alt = `صفحة ${pageNum}`;
                    pdfPage.style.display = 'block';
                    
                    // Update UI
                    updatePageNumber();
                    updateZoomDisplay();
                    updateButtonStates();
                    updateUrl();
                    
                    // Hide loading state
                    hideLoading();
                };
                
                // Handle image loading errors
                img.onerror = function(error) {
                    console.error(`Error loading page ${pageNum}:`, error);
                    if (imageUrl.startsWith('blob:')) {
                        URL.revokeObjectURL(imageUrl); // Clean up blob URL on error
                    }
                    showError(`حدث خطأ أثناء تحميل الصفحة ${pageNum}. يرجى المحاولة مرة أخرى.`);
                    hideLoading();
                };
                
                // Start loading the image
                img.src = imageUrl;
                
            } catch (error) {
                console.error('Error in loadPage:', error);
                showError(error.message || 'حدث خطأ غير متوقع. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                hideLoading();
                
                // If it's a 404, consider redirecting to the document detail page
                if (error.message.includes('404') || error.message.includes('not found')) {
                    setTimeout(() => {
                        window.location.href = documentDetailUrl;
                    }, 3000);
                }
            }
        }
        
        /**
         * Navigate to the previous page
         */
        function goToPrevPage() {
            if (currentPage > 1) {
                loadPage(currentPage - 1, currentZoom);
            }
        }
        
        /**
         * Navigate to the next page
         */
        function goToNextPage() {
            if (currentPage < totalPages) {
                loadPage(currentPage + 1, currentZoom);
            }
        }
        
        /**
         * Zoom in
         */
        function zoomIn() {
            // Calculate the next zoom level
            let newZoom = currentZoom + ZOOM_STEP;
            
            // Find the next zoom level from the predefined levels that's larger than current
            for (let i = 0; i < ZOOM_LEVELS.length; i++) {
                if (ZOOM_LEVELS[i] > currentZoom) {
                    newZoom = ZOOM_LEVELS[i];
                    break;
                }
            }
            
            // Don't exceed max zoom
            newZoom = Math.min(newZoom, MAX_ZOOM);
            
            if (newZoom !== currentZoom) {
                currentZoom = newZoom;
                updateZoomDisplay();
                loadPage(currentPage, currentZoom);
            }
        }
        
        /**
         * Zoom out
         */
        function zoomOut() {
            // Calculate the previous zoom level
            let newZoom = currentZoom - ZOOM_STEP;
            
            // Find the largest zoom level from the predefined levels that's smaller than current
            for (let i = ZOOM_LEVELS.length - 1; i >= 0; i--) {
                if (ZOOM_LEVELS[i] < currentZoom) {
                    newZoom = ZOOM_LEVELS[i];
                    break;
                }
            }
            
            // Don't go below min zoom
            newZoom = Math.max(newZoom, MIN_ZOOM);
            
            if (newZoom !== currentZoom) {
                currentZoom = newZoom;
                updateZoomDisplay();
                loadPage(currentPage, currentZoom);
            }
        }
        
        /**
         * Update zoom level display
         */
        function updateZoomDisplay() {
            if (zoomLevelEl) {
                zoomLevelEl.textContent = `${Math.round(currentZoom * 100)}%`;
            }
        }
        
        /**
         * Update button states based on current page and zoom
         */
        function updateButtonStates() {
            // Update navigation buttons
            if (prevBtn) {
                prevBtn.disabled = currentPage <= 1;
            }
            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages;
            }
            
            // Update zoom buttons
            if (zoomInBtn) {
                zoomInBtn.disabled = currentZoom >= MAX_ZOOM;
            }
            if (zoomOutBtn) {
                zoomOutBtn.disabled = currentZoom <= MIN_ZOOM;
            }
        }
        
        /**
         * Update the page number display
         */
        function updatePageNumber() {
            if (pageNumInput) {
                pageNumInput.textContent = currentPage;
            }
            if (pageCountElement) {
                pageCountElement.textContent = totalPages;
            }
        }
        
        /**
         * Update the URL without reloading the page
         */
        function updateUrl() {
            // Get the base URL without query parameters
            const baseUrl = window.location.pathname;
            
            // Create URLSearchParams object to handle query parameters
            const params = new URLSearchParams(window.location.search);
            
            // Update the page and zoom parameters
            params.set('page', currentPage);
            params.set('zoom', currentZoom);
            
            // Build the new URL with updated parameters
            const newUrl = `${baseUrl}?${params.toString()}`;
            
            // Update the browser's URL without reloading the page
            window.history.pushState(
                { page: currentPage, zoom: currentZoom },
                document.title,
                newUrl
            );
        }
        
        /**
         * Show loading state
         */
        function showLoading(message = 'جاري التحميل...') {
            console.log('Showing loading:', message);
            isLoading = true;
            if (loadingOverlay && loadingText) {
                loadingText.textContent = message;
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.opacity = '1';
                loadingOverlay.style.transition = 'opacity 0.3s ease';
            }
        }
        
        function hideLoading() {
            console.log('Hiding loading');
            isLoading = false;
            if (loadingOverlay) {
                // Fade out before hiding
                loadingOverlay.style.opacity = '0';
                loadingOverlay.addEventListener('transitionend', function handler() {
                    loadingOverlay.style.display = 'none';
                    loadingOverlay.removeEventListener('transitionend', handler);
                }, { once: true });
            }
        }
        
        /**
         * Display an error message to the user
         * @param {string} message - The error message to display
         * @param {string} [details=''] - Additional details to show (can contain HTML)
         * @param {boolean} [isFatal=false] - If true, shows a more prominent error and disables the viewer
         */
        function showError(message, details = '', isFatal = false) {
            console.error('Showing error:', { message, details, isFatal });
            
            // Get error elements
            const errorEl = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const errorDetails = document.getElementById('error-details');
            const errorActions = document.getElementById('error-actions');
            
            if (!errorEl || !errorText) {
                console.error('Error elements not found in the DOM');
                return;
            }
            
            // Set the main error message
            errorText.textContent = message || 'حدث خطأ غير معروف';
            
            // Set error details if provided
            if (details) {
                errorDetails.textContent = details;
                errorDetails.style.display = 'block';
            } else {
                errorDetails.style.display = 'none';
            }
            
            // Set up actions
            errorActions.innerHTML = '';
            
            // Add a refresh button for fatal errors
            if (isFatal) {
                const refreshBtn = document.createElement('button');
                refreshBtn.className = 'btn btn-sm btn-outline-light me-2';
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> إعادة تحميل الصفحة';
                refreshBtn.onclick = () => window.location.reload();
                errorActions.appendChild(refreshBtn);
                
                // Disable all interactive elements except our error actions
                const interactiveElements = document.querySelectorAll('button, input, select, a');
                interactiveElements.forEach(el => {
                    if (!el.closest('#error-message')) {
                        el.disabled = true;
                    }
                });
            }
            
            // Show the error element with animation
            errorEl.style.display = 'block';
            errorEl.style.opacity = '0';
            errorEl.style.transform = 'translateX(-50%) translateY(20px)';
            
            // Trigger reflow
            void errorEl.offsetWidth;
            
            // Fade in and slide up
            setTimeout(() => {
                errorEl.style.opacity = '1';
                errorEl.style.transform = 'translateX(-50%) translateY(0)';
            }, 10);
            
            // Auto-hide non-fatal errors after 10 seconds
            if (!isFatal) {
                setTimeout(hideError, 10000);
            } else {
                // For fatal errors, ensure loading is hidden
                hideLoading();
            }
        }
        
        /**
         * Hide the error message
         */
        function hideError() {
            const errorEl = document.getElementById('error-message');
            if (!errorEl) return;
            
            // Fade out and slide down
            errorEl.style.opacity = '0';
            errorEl.style.transform = 'translateX(-50%) translateY(20px)';
            
            // Hide after animation completes
            setTimeout(() => {
                if (errorEl) {
                    errorEl.style.display = 'none';
                }
            }, 300);
        }
        
        /**
         * Handle window resize with debounce to prevent excessive calculations
         */
        let resizeTimer;
        function handleResize() {
            // Clear the previous timer
            clearTimeout(resizeTimer);
            
            // Set a new timer to handle the resize after a short delay
            resizeTimer = setTimeout(() => {
                // Only proceed if we have a valid image
                if (pageImg && pageImg.complete && pageImg.naturalWidth > 0) {
                    // Initialize variables from data attributes
                    const container = document.querySelector('.pdf-viewer-container');
                    const documentId = container ? container.dataset.documentId : null;
                    let totalPages = container ? parseInt(container.dataset.totalPages) : 1;
                    let currentPage = container ? parseInt(container.dataset.currentPage) : 1;
                    const canDownload = container ? container.dataset.canDownload === 'true' : false;
                    const canEdit = container ? container.dataset.canEdit === 'true' : false;
                    
                    // UI Elements
                    const pdfViewer = document.getElementById('pdf-viewer');
                    const pageContainer = document.getElementById('page-container');
                    const prevBtn = document.getElementById('prev-page');
                    const nextBtn = document.getElementById('next-page');
                    const pageNumInput = document.getElementById('page-num');
                    const pageCountElement = document.getElementById('page-count');
                    const zoomInBtn = document.getElementById('zoom-in');
                    const zoomOutBtn = document.getElementById('zoom-out');
                    const zoomLevelEl = document.getElementById('zoom-level');
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const loadingText = document.getElementById('loading-text');
                    const errorEl = document.getElementById('error-message');
                    const errorText = document.getElementById('error-text');
                    
                    // If current zoom is larger than max, adjust it
                    if (currentZoom > maxZoom) {
                        currentZoom = maxZoom;
                        updateZoomDisplay();
                    }
                    
                    // Reload the current page with the current zoom level
                    // This will resize the image to fit the container
                    loadPage(currentPage, currentZoom);
                }
            }, 250); // Debounce time of 250ms
        }
        /**
         * Handle keyboard navigation
         */
        function handleKeyDown(e) {
            // Don't handle keyboard events if an input or textarea is focused
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                return;
            }
            
            // Handle Escape key to go back to document detail
            if (e.key === 'Escape') {
                const container = document.querySelector('.container-fluid');
                const detailUrl = container.getAttribute('data-document-detail-url');
                if (detailUrl) {
                    window.location.href = detailUrl;
                }
                return;
            }
            
            // Left arrow or Page Up: previous page
            if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
                e.preventDefault();
                goToPrevPage();
            }
            // Right arrow or Page Down or Space: next page
            else if (e.key === 'ArrowRight' || e.key === 'PageDown' || e.key === ' ') {
                e.preventDefault();
                goToNextPage();
            }
            // Home: first page
            else if (e.key === 'Home') {
                e.preventDefault();
                loadPage(1, currentZoom);
            }
            // End: last page
            else if (e.key === 'End') {
                e.preventDefault();
                loadPage(totalPages, currentZoom);
            }
            // Plus or equals: zoom in (with or without Shift)
            else if ((e.key === '+' || e.key === '=') && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                zoomIn();
            }
            // Minus or underscore: zoom out (with or without Shift)
            else if ((e.key === '-' || e.key === '_') && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                zoomOut();
            }
            // 0: reset zoom to 100%
            else if (e.key === '0' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                currentZoom = 1.0;
                updateZoomDisplay();
                loadPage(currentPage, currentZoom);
            }
            // Ctrl+Plus or Cmd+Plus: zoom in (browser zoom)
            else if ((e.key === '+' || e.key === '=') && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                zoomIn();
            }
            // Ctrl+Minus or Cmd+Minus: zoom out (browser zoom)
            else if ((e.key === '-' || e.key === '_') && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                zoomOut();
            }
            // Ctrl+0 or Cmd+0: reset zoom to 100% (browser zoom)
            else if (e.key === '0' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                currentZoom = 1.0;
                updateZoomDisplay();
                loadPage(currentPage, currentZoom);
            }
        }
        
        // Helper function to format file size
        function formatFileSize(bytes, decimals = 2) {
            if (bytes === 0 || bytes === undefined) return '0 بايت';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['بايت', 'كيلوبايت', 'ميجابايت', 'جيجابايت', 'تيرابايت'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            const size = parseFloat((bytes / Math.pow(k, i)).toFixed(dm));
            
            return `${size} ${sizes[i]}`;
        }
        
        // Debug function to test PDF loading
        function setupDebugButton() {
            const debugBtn = document.getElementById('debug-btn');
            if (!debugBtn) return;
            
            debugBtn.addEventListener('click', async () => {
                try {
                    showLoading('جاري تشغيل اختبار التصحيح...');
                    
                    // Test 1: Check if document ID is valid
                    if (!documentId) {
                        throw new Error('معرف المستند غير صالح');
                    }
                    
                    // Test 2: Try to fetch document info
                    const infoUrl = `/pdf-reader/${documentId}/info/`;
                    console.log('Fetching document info from:', infoUrl);
                    
                    const infoResponse = await fetch(infoUrl, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (!infoResponse.ok) {
                        try {
                            const errorData = await infoResponse.json();
                            throw new Error(`فشل جلب معلومات المستند (${infoResponse.status}): ${errorData.error || 'خطأ غير معروف'}`);
                        } catch (e) {
                            const errorText = await infoResponse.text();
                            throw new Error(`فشل جلب معلومات المستند (${infoResponse.status} ${infoResponse.statusText}): ${errorText || 'لا توجد تفاصيل إضافية'}`);
                        }
                    }
                    
                    const docInfo = await infoResponse.json();
                    console.log('Document info:', docInfo);
                    
                    // Check if we have permission
                    if (docInfo.has_permission === false) {
                        throw new Error('ليس لديك صلاحية لعرض هذا المستند');
                    }
                    
                    // Check if file exists
                    if (!docInfo.file || docInfo.file.exists === false) {
                        throw new Error('ملف المستند غير موجود على الخادم');
                    }
                    
                    // Check if it's a PDF
                    if (docInfo.pdf && docInfo.pdf.is_pdf === false) {
                        throw new Error('هذا الملف ليس مستند PDF');
                    }
                    
                    // Test 3: Try to load the first page
                    const pageUrl = `/pdf-reader/${documentId}/viewer/page/1/`;
                    console.log('Testing page load from:', pageUrl);
                    
                    const pageResponse = await fetch(pageUrl, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'image/*'
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (!pageResponse.ok) {
                        const errorText = await pageResponse.text();
                        throw new Error(`فشل تحميل الصفحة: ${pageResponse.status} ${pageResponse.statusText}\n${errorText}`);
                    }
                    
                    // Test 4: Check if we got an image
                    const contentType = pageResponse.headers.get('content-type') || '';
                    if (!contentType.includes('image/')) {
                        const responseText = await pageResponse.text();
                        throw new Error(`توقعنا صورة ولكن حصلنا على: ${contentType}\n${responseText.substring(0, 200)}`);
                    }
                    
                    // If we got here, everything worked!
                    hideLoading();
                    
                    // Build detailed success message
                    let successDetails = [
                        `المستند: ${docInfo.title || 'غير معروف'}`,
                        `معرف المستند: ${docInfo.id}`,
                        `عدد الصفحات: ${docInfo.pdf?.page_count || 'غير معروف'}`,
                        `حجم الملف: ${formatFileSize(docInfo.file?.size)}`,
                        `تم الرفع بواسطة: ${docInfo.uploaded_by || 'غير معروف'}`,
                        `تاريخ الرفع: ${new Date(docInfo.uploaded_at).toLocaleString('ar-SA')}`,
                        `حالة الملف: ${docInfo.file?.exists ? 'موجود' : 'غير موجود'}`,
                        `نوع الملف: ${docInfo.pdf?.is_pdf ? 'PDF' : 'غير PDF'}`
                    ];
                    
                    showError(
                        '✅ اختبار التصحيح اكتمل بنجاح!',
                        successDetails.join('\n'),
                        false
                    );
                    
                    // Log detailed info to console
                    console.group('✅ PDF Viewer Debug - Success');
                    console.log('Document Info:', docInfo);
                    console.log('Page Load Test: Success');
                    console.groupEnd();
                    
                } catch (error) {
                    console.error('Debug test failed:', error);
                    
                    // Log detailed error to console
                    console.group('❌ PDF Viewer Debug - Error');
                    console.error('Error:', error);
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    console.error('Error stack:', error.stack);
                    
                    // Log additional context
                    console.log('Document ID:', documentId);
                    console.log('Current URL:', window.location.href);
                    console.log('User Agent:', navigator.userAgent);
                    console.groupEnd();
                    
                    // Prepare error details
                    let errorDetails = [
                        `الخطأ: ${error.message || 'خطأ غير معروف'}`,
                        `نوع الخطأ: ${error.name || 'غير معروف'}`,
                        '',
                        'تفاصيل إضافية متوفرة في وحدة تحكم المتصفح (F12)'
                    ];
                    
                    // Add more context for common errors
                    if (error.message && error.message.includes('NetworkError')) {
                        errorDetails.splice(2, 0, 'ملاحظة: يبدو أن هناك مشكلة في الاتصال بالخادم');
                    } else if (error.message && error.message.includes('404')) {
                        errorDetails.splice(2, 0, 'ملاحظة: الصفحة المطلوبة غير موجودة (404)');
                    } else if (error.message && error.message.includes('403')) {
                        errorDetails.splice(2, 0, 'ملاحظة: غير مصرح لك بالوصول إلى هذا المورد (403)');
                    } else if (error.message && error.message.includes('500')) {
                        errorDetails.splice(2, 0, 'ملاحظة: حدث خطأ في الخادم (500)');
                    }
                    
                    showError(
                        '❌ فشل اختبار التصحيح',
                        errorDetails.join('\n'),
                        true
                    );
                }
            });
        }
        
        // Add event listeners
        document.addEventListener('keydown', handleKeyDown);
        window.addEventListener('resize', handleResize);
        
        // Setup debug button
        setupDebugButton();
        
        // Initialize the viewer when the document is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Set document title
            document.title = documentTitle + ' - ' + '{% trans "عرض المستند" %}';
            
            // Initialize UI elements
            if (document.getElementById('document-title')) {
                document.getElementById('document-title').textContent = documentTitle;
            }
            
            // Set up page navigation
            updatePageNumber();
            updateButtonStates();
            updateZoomDisplay();
            
            // Load the initial page
            loadPage(currentPage, currentZoom);
            
            // Focus the container for keyboard events
            container.focus();
        });
        
        // Clean up event listeners when the component is unloaded
        window.addEventListener('beforeunload', function() {
            window.removeEventListener('resize', handleResize);
            document.removeEventListener('keydown', handleKeyDown);
        });
    })(window, document);
</script>
{% endblock %}

{% extends 'pdf_reader/pdf_reader_base.html' %}
{% load static i18n %}

{% block extra_css %}
<style>
    /* Minimal styles for embedded viewer */
    body {
        padding: 0;
        margin: 0;
        background-color: #f8f9fa;
    }
    
    .pdf-embed-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-height: 100vh;
        overflow: hidden;
    }
    
    .pdf-embed-toolbar {
        padding: 0.5rem;
        background-color: #f1f3f5;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .pdf-embed-title {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 50%;
    }
    
    .pdf-embed-actions {
        display: flex;
        gap: 0.25rem;
    }
    
    .pdf-embed-content {
        flex: 1;
        overflow: auto;
        background-color: #525659;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 1rem;
    }
    
    .pdf-embed-page {
        background-color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        margin: 0 auto;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .pdf-embed-toolbar {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        
        .pdf-embed-title {
            max-width: 100%;
            text-align: center;
        }
        
        .pdf-embed-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pdf-embed-container">
    <div class="pdf-embed-toolbar">
        <h2 class="pdf-embed-title" title="{{ document.title }}">
            {{ document.title|truncatechars:60 }}
        </h2>
        <div class="pdf-embed-actions">
            <div class="btn-group btn-group-sm">
                <button id="prev-page" class="btn btn-outline-secondary" title="{% trans 'Previous Page' %}">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="input-group-text">
                    <span id="page-num">1</span> / <span id="page-count">-</span>
                </span>
                <button id="next-page" class="btn btn-outline-secondary" title="{% trans 'Next Page' %}">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="btn-group btn-group-sm ms-2">
                <button id="zoom-out" class="btn btn-outline-secondary" title="{% trans 'Zoom Out' %}">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button id="zoom-in" class="btn btn-outline-secondary" title="{% trans 'Zoom In' %}">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button id="fit-width" class="btn btn-outline-secondary" title="{% trans 'Fit Width' %}">
                    <i class="fas fa-arrows-alt-h"></i>
                </button>
                <button id="fit-page" class="btn btn-outline-secondary" title="{% trans 'Fit Page' %}">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            {% if can_download %}
            <div class="btn-group btn-group-sm ms-2">
                <a href="{{ document.get_download_url }}" class="btn btn-outline-primary" download title="{% trans 'Download' %}">
                    <i class="fas fa-download"></i>
                </a>
            </div>
            {% endif %}
            {% if can_edit %}
            <div class="btn-group btn-group-sm ms-2">
                <a href="{{ document.get_edit_url }}" class="btn btn-outline-secondary" title="{% trans 'Edit' %}" target="_blank">
                    <i class="fas fa-edit"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="pdf-embed-content">
        <div id="pdf-loading" class="text-center py-5">
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">{% trans 'Loading...' %}</span>
            </div>
            <p class="text-light mt-2">{% trans 'Loading PDF document...' %}</p>
        </div>
        <canvas id="pdf-canvas" class="d-none"></canvas>
    </div>
    
    <div id="error-message" class="alert alert-danger m-3 d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="error-text"></span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // PDF.js configuration
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        
        // DOM elements
        const container = document.querySelector('.pdf-embed-content');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const pageNumEl = document.getElementById('page-num');
        const pageCountEl = document.getElementById('page-count');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const fitWidthBtn = document.getElementById('fit-width');
        const fitPageBtn = document.getElementById('fit-page');
        const loadingEl = document.getElementById('pdf-loading');
        const errorEl = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // PDF document and page variables
        let pdfDoc = null;
        let pageNum = {{ current_page|default:1 }};
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        let containerWidth = container.clientWidth;
        
        // Initialize the PDF viewer
        function initPdfViewer() {
            // Configure PDF.js worker
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
            
            // Get the PDF URL
            const pdfUrl = '{{ document.file.url|escapejs }}';
            
            // Load the PDF document
            const loadingTask = pdfjsLib.getDocument({
                url: pdfUrl,
                withCredentials: true,
                httpHeaders: {
                    'Accept': 'application/pdf',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            });
            
            loadingTask.promise.then(function(pdfDoc_) {
                pdfDoc = pdfDoc_;
                
                // Update page count
                if (pageCountEl) {
                    pageCountEl.textContent = pdfDoc.numPages;
                }
                
                // Initial page rendering
                return renderPage(pageNum);
                
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
                showError('{% trans "Error loading PDF. Please try again or download the file." %}');
            });
        }
        
        // Show error message
        function showError(message) {
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorEl && errorText) {
                errorText.textContent = message;
                errorEl.classList.remove('d-none');
            }
        }
        
        // Render a page with error handling
        function renderPage(num, zoom = null) {
            if (!pdfDoc) {
                console.error('PDF document not loaded');
                return Promise.reject(new Error('PDF document not loaded'));
            }

            if (pageRendering) {
                pageNumPending = num;
                return Promise.resolve();
            }
            
            pageRendering = true;
            
            // Show loading state for page
            if (loadingEl) {
                loadingEl.style.display = 'block';
                loadingEl.innerHTML = `
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">{% trans 'Loading...' %}</span>
                    </div>
                    <p class="text-light mt-2">
                        {% trans 'Loading page' %} ${num} {% trans 'of' %} ${pdfDoc.numPages}
                    </p>
                `;
            }
            
            // Hide canvas while loading
            canvas.classList.add('d-none');
            
            // Update page number
            pageNum = num;
            
            // Update button states
            if (prevBtn) prevBtn.disabled = num <= 1;
            if (nextBtn) nextBtn.disabled = num >= pdfDoc.numPages;
            if (pageNumEl) pageNumEl.textContent = num;
            
            // Get the page with error handling
            return pdfDoc.getPage(num).then(function(page) {
                // Calculate scale based on zoom level or container width
                let newScale = scale;
                const viewport = page.getViewport({ scale: 1.0 });
                
                if (zoom === 'width') {
                    const containerWidth = container.clientWidth - 40; // Account for padding
                    newScale = containerWidth / viewport.width;
                } else if (zoom === 'page') {
                    const containerWidth = container.clientWidth - 40;
                    const containerHeight = container.clientHeight - 40;
                    const scaleX = containerWidth / viewport.width;
                    const scaleY = containerHeight / viewport.height;
                    newScale = Math.min(scaleX, scaleY);
                } else if (typeof zoom === 'number') {
                    newScale = zoom;
                }
                
                // Update global scale if it changed
                scale = newScale;
                
                // Get viewport with the correct scale
                const scaledViewport = page.getViewport({ scale: scale });
                
                // Set canvas dimensions
                const outputScale = window.devicePixelRatio || 1;
                canvas.width = Math.floor(scaledViewport.width * outputScale);
                canvas.height = Math.floor(scaledViewport.height * outputScale);
                canvas.style.width = Math.floor(scaledViewport.width) + "px";
                canvas.style.height = Math.floor(scaledViewport.height) + "px";
                
                // Get canvas context with proper scaling
                const context = canvas.getContext('2d');
                context.scale(outputScale, outputScale);
                
                // Render PDF page
                const renderContext = {
                    canvasContext: context,
                    viewport: scaledViewport,
                    intent: 'display'
                };
                
                const renderTask = page.render(renderContext);
                
                // Wait for rendering to finish
                return renderTask.promise.then(function() {
                    pageRendering = false;
                    
                    // Hide loading and show canvas
                    if (loadingEl) loadingEl.style.display = 'none';
                    canvas.classList.remove('d-none');
                    
                    // Update URL with page number (without reloading)
                    const url = new URL(window.location.href);
                    url.searchParams.set('page', num);
                    window.history.replaceState({}, '', url);
                    
                    // Resolve any pending page rendering
                    if (pageNumPending !== null) {
                        const nextPageNum = pageNumPending;
                        pageNumPending = null;
                        renderPage(nextPageNum);
                    }
                });
            }).catch(function(error) {
                console.error('Error rendering page:', error);
                showError('{% trans "Error rendering PDF page. Please try again." %}');
                pageRendering = false;
                return Promise.reject(error);
            });
        }
        
        // Queue a page rendering
        function queueRenderPage(num, zoom = null) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num, zoom);
            }
        }
        
        // Event listeners
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                if (pageNum <= 1 || !pdfDoc) return;
                queueRenderPage(pageNum - 1);
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
                queueRenderPage(pageNum + 1);
            });
        }
        
        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', function() {
                if (!pdfDoc) return;
                scale *= 1.25;
                queueRenderPage(pageNum, scale);
            });
        }
        
        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', function() {
                if (!pdfDoc) return;
                scale = Math.max(0.5, scale / 1.25);
                queueRenderPage(pageNum, scale);
            });
        }
        
        if (fitWidthBtn) {
            fitWidthBtn.addEventListener('click', function() {
                if (!pdfDoc) return;
                queueRenderPage(pageNum, 'width');
            });
        }
        
        if (fitPageBtn) {
            fitPageBtn.addEventListener('click', function() {
                if (!pdfDoc) return;
                queueRenderPage(pageNum, 'page');
            });
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (!pdfDoc) return;
            
            // Don't interfere with form controls
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                return;
            }
            
            switch (e.key) {
                case 'ArrowLeft':
                case 'PageUp':
                    if (pageNum > 1) {
                        queueRenderPage(pageNum - 1);
                        e.preventDefault();
                    }
                    break;
                    
                case 'ArrowRight':
                case 'PageDown':
                case ' ':
                    if (pageNum < pdfDoc.numPages) {
                        queueRenderPage(pageNum + 1);
                        e.preventDefault();
                    }
                    break;
                    
                case 'Home':
                    if (pageNum !== 1) {
                        queueRenderPage(1);
                        e.preventDefault();
                    }
                    break;
                    
                case 'End':
                    if (pageNum !== pdfDoc.numPages) {
                        queueRenderPage(pdfDoc.numPages);
                        e.preventDefault();
                    }
                    break;
                    
                case '+':
                    if (e.ctrlKey || e.metaKey) {
                        scale *= 1.25;
                        queueRenderPage(pageNum, scale);
                        e.preventDefault();
                    }
                    break;
                    
                case '-':
                    if (e.ctrlKey || e.metaKey) {
                        scale = Math.max(0.5, scale / 1.25);
                        queueRenderPage(pageNum, scale);
                        e.preventDefault();
                    }
                    break;
                    
                case '0':
                    if (e.ctrlKey || e.metaKey) {
                        queueRenderPage(pageNum, 'width');
                        e.preventDefault();
                    }
                    break;
            }
        });
        
        // Handle window resize with debounce
        let resizeTimeout;
        function handleResize() {
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            resizeTimeout = setTimeout(function() {
                containerWidth = container.clientWidth;
                if (pdfDoc) {
                    queueRenderPage(pageNum, 'width');
                }
            }, 250);
        }
        
        // Add resize event listener
        window.addEventListener('resize', handleResize);
        
        // Clean up event listeners when the component is removed
        window.addEventListener('unload', function() {
            window.removeEventListener('resize', handleResize);
            document.removeEventListener('keydown', handleKeyDown);
        });
        
        // Initialize the PDF viewer
        initPdfViewer();
    });
</script>
{% endblock %}

{% extends 'hadith_app/base.html' %}
{% load i18n static humanize %}

{% block title %}{{ document.title }} - {% trans 'عرض المستند' %}{% endblock %}

{% block extra_css %}
<style>
    .document-header {
        background: linear-gradient(135deg, #f8f9ff 0%, #eef2ff 100%);
        border-radius: 1rem;
        padding: 2.5rem 2rem;
        margin: -1.5rem 0 2.5rem;
        border: 1px solid rgba(99, 102, 241, 0.1);
        position: relative;
        overflow: hidden;
    }
    
    .document-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 90% 10%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
        pointer-events: none;
    }
    
    .document-preview {
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        background: white;
        margin-bottom: 2rem;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .document-preview:hover {
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .document-actions .btn {
        border-radius: 0.75rem;
        padding: 0.6rem 1.5rem;
        font-weight: 500;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        margin-right: 0.75rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 120px;
    }
    
    .document-actions .btn i {
        transition: transform 0.2s ease;
    }
    
    .document-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .document-actions .btn:hover i {
        transform: translateX(3px);
    }
    
    .btn-download {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        border: none;
        color: white;
    }
    
    .btn-print {
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        border: none;
        color: white;
    }
    
    .btn-share {
        background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        border: none;
        color: white;
    }
    
    .document-actions .btn i {
        margin-left: 0.5rem;
    }
    
    .document-info-card {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.04);
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.04);
    }
    
    .document-info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.08);
    }
    
    .document-info-card .card-header {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        font-weight: 600;
        padding: 1.25rem 1.5rem;
        font-size: 1.1rem;
        color: #1f2937;
        display: flex;
        align-items: center;
    }
    
    .document-info-card .card-header i {
        margin-left: 0.75rem;
        color: #4f46e5;
    }
    
    .document-info-card .card-body {
        padding: 1.5rem;
    }
    
    .info-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    }
    
    .info-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .info-icon {
        width: 40px;
        height: 40px;
        border-radius: 0.75rem;
        background: #eef2ff;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 1rem;
        flex-shrink: 0;
        color: #4f46e5;
    }
    
    .info-content {
        flex: 1;
    }
    
    .info-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }
    
    .info-value {
        font-weight: 500;
        color: #1f2937;
        margin: 0;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .info-item:last-child {
        border-bottom: none;
    }
    
    .info-item i {
        width: 24px;
        text-align: center;
        margin-left: 0.75rem;
        color: #6c757d;
    }
    
    .document-description {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
    }
    
    .related-document {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
        text-decoration: none !important;
        color: #212529;
    }
    
    .related-document:hover {
        background: #f8f9fa;
        transform: translateY(-2px);
    }
    
    .related-document i {
        font-size: 1.5rem;
        margin-left: 1rem;
        color: #6c757d;
    }
    
    .document-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
    }
    
    /* PDF Viewer Styles */
    #pdf-viewer-container {
        min-height: 70vh;
        max-height: 80vh;
        position: relative;
        background-color: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    #pdf-viewer-container:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }
    
    #pdf-viewer, #pdf-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: #fff;
    }
    
    #loading-message {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        z-index: 10;
    }
    
    #error-message {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        z-index: 20;
        display: none;
    }
    
    .document-actions {
        margin: 1.5rem 0;
    }
    
    @media (max-width: 768px) {
        .document-actions .btn {
            width: 100%;
            margin-right: 0;
            margin-bottom: 0.5rem;
        }
    }
    
    @media (max-width: 768px) {
        #pdf-viewer-container {
            min-height: 50vh;
            max-height: 60vh;
        }
    }
    
    /* Animation for loading */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 0.9; }
        50% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(1); opacity: 0.9; }
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
        100% { transform: translateY(0px); }
    }
    
    @keyframes progressPulse {
        0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }
    
    .document-icon-container {
        position: relative;
        animation: float 3s ease-in-out infinite;
    }
    
    .document-icon-container::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 10px;
        background: rgba(0,0,0,0.05);
        bottom: -15px;
        left: 0;
        border-radius: 50%;
        filter: blur(4px);
        animation: shadowPulse 3s ease-in-out infinite;
    }
    
    @keyframes shadowPulse {
        0% { transform: scale(0.95); opacity: 0.7; }
        50% { transform: scale(1.05); opacity: 0.9; }
        100% { transform: scale(0.95); opacity: 0.7; }
    }
    
    /* Progress bar animation */
    .progress-bar {
        position: relative;
        overflow: visible;
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Loading skeleton */
    .skeleton {
        background: linear-gradient(90deg, #f5f5f5 25%, #e9ecef 50%, #f5f5f5 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 6px;
    }
    
    @keyframes skeleton-loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    /* Smooth transitions for status updates */
    #status-text, #loading-tip {
        transition: all 0.3s ease;
    }
    
    /* Responsive adjustments */
    @media (max-width: 576px) {
        .document-icon-container i {
            font-size: 3rem !important;
        }
        
        .progress {
            height: 6px !important;
        }
    }
    
    /* Ensure PDF viewer takes full height */
    #pdf-viewer, #pdf-iframe {
        width: 100%;
        height: 100%;
        min-height: 70vh;
        border: none;
    }
    
    /* Improve button styles */
    .btn-group .btn {
        margin: 0 0.25rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        #pdf-viewer-container {
            min-height: 50vh;
        }
        
        .document-actions .btn {
            width: 100%;
            margin: 0.25rem 0;
        }
    }
    
    /* Button styles */
    .btn-retry {
        min-width: 120px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-retry i {
        margin-right: 5px;
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
    
    /* Card hover effect */
    .card {
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            800px circle at var(--mouse-x) var(--mouse-y),
            rgba(99, 102, 241, 0.1),
            transparent 40%
        );
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    
    .card:hover::before {
        opacity: 1;
    }
    
    /* Button hover effect */
    .btn {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%, -50%);
        transform-origin: 50% 50%;
    }
    
    .btn:active::after {
        animation: ripple 0.6s ease-out;
    }
    
    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(50, 50);
            opacity: 0;
        }
    }
    
    /* Loading animation */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .document-header {
            padding: 1.5rem 1rem;
            margin: -1rem -1rem 1.5rem;
            border-radius: 0;
        }
        
        .document-actions .btn {
            width: 100%;
            margin: 0.25rem 0;
        }
        
        .info-item {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .info-icon {
            margin: 0 0 0.75rem 0;
        }
    }
</style>
{% endblock %}

{% block content %}
{% load static %}
<div class="container py-4 px-lg-5">
    <!-- Document Header -->
    <div class="document-header">
        <div class="d-flex justify-content-between align-items-start position-relative z-10">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a href="{% url 'pdf_reader:document_list' %}" class="text-decoration-none">
                            <i class="fas fa-arrow-right me-2"></i>{% trans 'المكتبة' %}
                        </a></li>
                        <li class="breadcrumb-item active" aria-current="page">{{ document.title|truncatechars:30 }}</li>
                    </ol>
                </nav>
                <h1 class="h2 mb-3 fw-bold text-gray-900">{{ document.title }}</h1>
                <div class="d-flex flex-wrap align-items-center text-muted mb-3" style="gap: 0.75rem;">
                    <div class="me-3">
                        <i class="fas fa-user me-1"></i>
                        {{ document.uploaded_by.get_full_name|default:document.uploaded_by.username }}
                    </div>
                    <div class="me-3">
                        <i class="far fa-calendar-alt me-1"></i>
                        {{ document.uploaded_at|date:"Y/m/d" }}
                    </div>
                    <span class="badge {% if document.is_public %}bg-success{% else %}bg-gray-600{% endif %} document-badge rounded-pill px-3 py-2 fw-normal">
                        {% if document.is_public %}{% trans 'عام' %}{% else %}{% trans 'خاص' %}{% endif %}
                    </span>
                </div>
            </div>
            {% if document.uploaded_by == request.user or request.user.is_staff %}
            <div class="dropdown ms-3">
                <button class="btn btn-outline-primary btn-sm rounded-pill px-3" type="button" id="documentActions" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="documentActions">
                    <li>
                        <a class="dropdown-item" href="{% url 'pdf_reader:document_update' document.pk %}">
                            <i class="fas fa-edit me-2"></i>{% trans 'تعديل المستند' %}
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-danger" href="#" 
                           data-delete-url="{% url 'pdf_reader:document_delete' document.pk %}"
                           onclick="return confirmDelete(this);">
                            <i class="fas fa-trash me-2"></i>{% trans 'حذف المستند' %}
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Document Preview -->
            <div class="document-preview">
                <div id="pdf-viewer-container" class="position-relative bg-gray-50 rounded-lg overflow-hidden" style="height: 85vh; min-height: 650px; border: 1px solid rgba(0, 0, 0, 0.05);">
                    <!-- Loading message -->
                    <div id="loading-message" class="w-100 h-100 d-flex align-items-center justify-content-center position-absolute top-0 start-0" 
                         style="z-index: 10; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(8px);">
                        <div class="text-center p-5 bg-white rounded-2xl shadow-xl border border-gray-100 animate__animated animate__fadeIn" style="max-width: 500px; width: 90%;">
                            <!-- Animated document icon with pulse effect -->
                            <div class="position-relative mb-6" style="height: 140px;">
                                <div class="position-absolute w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                                    <div class="document-icon-container position-relative animate-pulse" style="animation-duration: 2s;">
                                        <div class="position-absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-24 h-24 bg-indigo-50 rounded-full"></div>
                                        <i class="fas fa-file-pdf text-indigo-600" style="font-size: 4.5rem; filter: drop-shadow(0 6px 8px rgba(79, 70, 229, 0.15));"></i>
                                    </div>
                                    
                                    <!-- Progress bar with gradient -->
                                    <div class="relative w-full max-w-md mt-8">
                                        <div class="text-xs text-gray-500 mb-1 text-right">
                                            <span id="progress-text">0% {% trans 'مكتمل' %}</span>
                                        </div>
                                        <div class="h-2.5 w-full bg-gray-200 rounded-full overflow-hidden">
                                            <div id="loading-progress" 
                                                 class="h-full bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full transition-all duration-500 ease-out"
                                                 style="width: 0%; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.25);">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loading text with animation -->
                            <div class="text-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-3 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                                    <i class="fas fa-file-pdf text-indigo-600 mr-2"></i>
                                    {% trans 'جاري تحميل المستند' %}
                                </h3>
                                <p class="text-gray-600 mb-0 animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                                    <i class="fas fa-spinner fa-spin mr-2 text-indigo-500"></i>
                                    <span id="status-text" class="text-gray-700">{% trans 'جاري تحميل الملف، الرجاء الانتظار...' %}</span>
                                </p>
                            </div>
                            
                            <!-- Time remaining -->
                            <div class="flex items-center justify-center text-sm text-gray-500 mb-6 animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
                                <i class="far fa-clock mr-1.5"></i>
                                <span id="time-remaining">{% trans 'أقل من دقيقة' %}</span>
                            </div>
                            
                            <!-- Loading tips with animation -->
                            <div class="mt-6 pt-4 border-t border-gray-100 animate__animated animate__fadeInUp" style="animation-delay: 0.5s;">
                                <div class="flex items-center justify-center mb-2">
                                    <div class="bg-indigo-50 text-indigo-700 rounded-full px-3 py-1.5 text-xs font-medium inline-flex items-center">
                                        <i class="fas fa-lightbulb text-amber-400 mr-1.5"></i>
                                        <span>{% trans 'نصيحة' %}</span>
                                    </div>
                                </div>
                                <p class="text-center text-sm text-gray-500 animate__animated animate__fadeIn" style="animation-delay: 0.6s;">
                                    <span id="loading-tip">{% trans 'يمكنك تكبير/تصغير الصفحة باستخدام عجلة الماوس مع الضغط على زر Ctrl' %}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PDF viewer component -->
                    <div id="pdf-viewer" class="w-full h-full flex flex-col" style="display: none;">
                        <!-- PDF Viewer Toolbar -->
                        <div class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between shadow-sm">
                            <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                <button id="prev-page" class="p-2 rounded-md hover:bg-gray-100 text-gray-600 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed" title="{% trans 'الصفحة السابقة' }}">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <span class="text-sm text-gray-600">
                                    <span id="page-num">1</span> / <span id="page-count">-</span>
                                </span>
                                <button id="next-page" class="p-2 rounded-md hover:bg-gray-100 text-gray-600 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed" title="{% trans 'الصفحة التالية' }}">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                
                                <span class="mx-2 text-gray-300">|</span>
                                
                                <div class="flex items-center bg-gray-50 rounded-full px-2">
                                    <button id="zoom-out" class="p-1.5 text-gray-500 hover:text-gray-700" title="{% trans 'تصغير' }}">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <span id="zoom-level" class="mx-2 text-sm font-medium text-gray-600 w-12 text-center">100%</span>
                                    <button id="zoom-in" class="p-1.5 text-gray-500 hover:text-gray-700" title="{% trans 'تكبير' }}">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                </div>
                                
                                <button id="fit-width" class="p-2 rounded-md hover:bg-gray-100 text-gray-600 hover:text-gray-900" title="{% trans 'تناسب العرض' }}">
                                    <i class="fas fa-arrows-alt-h"></i>
                                </button>
                                <button id="fit-page" class="p-2 rounded-md hover:bg-gray-100 text-gray-600 hover:text-gray-900" title="{% trans 'تناسب الصفحة' }}">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            
                            <div class="flex items-center">
                                <a href="{{ document.file.url }}" class="p-2 rounded-md hover:bg-gray-100 text-gray-600 hover:text-gray-900" title="{% trans 'تحميل' }}" download>
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                        
                        <!-- PDF Container -->
                        <div class="flex-1 relative overflow-auto">
                            {% if document.file.url|lower|slice:'-4:' == '.pdf' %}
                                <div id="pdf-canvas-container" class="absolute inset-0 flex items-center justify-center p-4">
                                    <canvas id="pdf-canvas" class="shadow-lg rounded-lg bg-white"></canvas>
                                </div>
                            {% else %}
                                <div class="h-full flex items-center justify-center bg-gray-50">
                                    <div class="text-center p-6 max-w-md">
                                        <div class="bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <i class="fas fa-file-alt text-2xl text-indigo-600"></i>
                                        </div>
                                        <h4 class="text-lg font-medium text-gray-900 mb-2">{% trans 'عرض المستند' %}</h4>
                                        <p class="text-gray-500 mb-4">{% trans 'هذا النوع من الملفات لا يدعم العرض المباشر' %}</p>
                                        <a href="{{ document.file.url }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" download>
                                            <i class="fas fa-download ml-2"></i>
                                            {% trans 'تحميل الملف' %}
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Error message -->
                        <div id="error-message" class="hidden absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center p-6">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 mb-2">{% trans 'حدث خطأ' %}</h4>
                                <p id="error-text" class="text-gray-500 mb-4"></p>
                                <button id="retry-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <i class="fas fa-redo mr-2"></i>
                                    {% trans 'إعادة المحاولة' %}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add CSRF token if using Django's CSRF protection -->
                    {% csrf_token %}
                </div>
            </div>
            
            <!-- Document Actions -->
            <div class="document-actions mb-4">
                <a href="{% url 'pdf_reader:document_download' document.pk %}" class="btn btn-download">
                    <i class="fas fa-download me-1"></i> {% trans 'تحميل المستند' %}
                </a>
                <button class="btn btn-print" onclick="window.print()">
                    <i class="fas fa-print me-1"></i> {% trans 'طباعة' %}
                </button>
                <button class="btn btn-share" id="shareBtn">
                    <i class="fas fa-share-alt me-1"></i> {% trans 'مشاركة' %}
                </button>
                {% if document.is_pdf %}
                <a href="{% url 'pdf_reader:document_view' document.pk %}" target="_blank" class="btn btn-outline-primary">
                    <i class="fas fa-expand me-1"></i> {% trans 'عرض كامل' %}
                </a>
                {% endif %}
            </div>

            <!-- Document Description -->
            {% if document.description %}
            <div class="document-description">
                <h5 class="mb-3"><i class="fas fa-align-right text-primary me-2"></i>{% trans 'الوصف' %}</h5>
                <p class="text-muted mb-0">{{ document.description }}</p>
            </div>
            {% endif %}
            
            <!-- Document Information -->
            <div class="row">
                <div class="col-md-6">
                    <div class="document-info-card">
                        <div class="card-header">
                            <i class="fas fa-info-circle me-2"></i>{% trans 'معلومات الملف' %}
                        </div>
                        <div class="card-body">
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="info-content">
                                    <div class="info-label">{% trans 'نوع الملف' %}</div>
                                    <div class="info-value">{{ document.get_file_extension|upper }}</div>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-weight-hanging"></i>
                                </div>
                                <div class="info-content">
                                    <div class="info-label">{% trans 'حجم الملف' %}</div>
                                    <div class="info-value">{{ document.file.size|filesizeformat }}</div>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="info-content">
                                    <div class="info-label">{% trans 'تم الرفع بواسطة' %}</div>
                                    <div class="info-value">{{ document.uploaded_by.get_full_name|default:document.uploaded_by.username }}</div>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="far fa-calendar-alt"></i>
                                </div>
                                <div class="info-content">
                                    <div class="info-label">{% trans 'تاريخ الرفع' %}</div>
                                    <div class="info-value">{{ document.uploaded_at|date:"Y/m/d - H:i" }}</div>
                                </div>
                            </div>
                            {% if document.modified_at %}
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="info-content">
                                    <div class="info-label">{% trans 'آخر تعديل' %}</div>
                                    <div class="info-value">{{ document.modified_at|date:"Y/m/d - H:i" }}</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="document-info-card">
                        <div class="card-header">
                            <i class="fas fa-info-circle me-2"></i>{% trans 'معلومات إضافية' %}
                        </div>
                        <div class="card-body">
                            <div class="info-item">
                                <i class="fas fa-eye"></i>
                                <div>
                                    <div class="text-muted small">{% trans 'عدد المشاهدات' %}</div>
                                    <div>{{ document.view_count|default:0 }}</div>
                                </div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-download"></i>
                                <div>
                                    <div class="text-muted small">{% trans 'عدد مرات التحميل' %}</div>
                                    <div>{{ document.download_count|default:0 }}</div>
                                </div>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar-check"></i>
                                <div>
                                    <div class="text-muted small">{% trans 'تاريخ الإنشاء' %}</div>
                                    <div>{{ document.created_at|date:"Y/m/d" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>

            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Related Documents -->
            <div class="document-info-card mb-4">
                <div class="card-header">
                    <i class="fas fa-link me-2"></i>{% trans 'مستندات ذات صلة' %}
                </div>
                <div class="row g-3">
                    {% for related_doc in related_documents %}
                    <div class="col-12 col-md-6 col-lg-12">
                        <a href="{% url 'pdf_reader:document_detail' related_doc.pk %}" class="card card-hover h-100 text-decoration-none">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="bg-light rounded p-3 text-center" style="width: 60px;">
                                            <i class="fas fa-file-pdf text-danger fa-2x"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 text-dark">{{ related_doc.title|truncatechars:60 }}</h6>
                                        <div class="d-flex align-items-center text-muted small">
                                            <span class="me-3">
                                                <i class="far fa-user me-1"></i>
                                                {{ related_doc.uploaded_by.get_full_name|default:related_doc.uploaded_by.username }}
                                            </span>
                                            <span>
                                                <i class="far fa-clock me-1"></i>
                                                {{ related_doc.uploaded_at|timesince }} {% trans 'منذ' %}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 ms-3 text-muted">
                                        <i class="fas fa-chevron-left"></i>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="alert alert-light border-0 shadow-sm">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle text-primary me-2"></i>
                                <div>{% trans 'لا توجد مستندات ذات صلة' %}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <style>
                .card-hover {
                    transition: all 0.3s ease;
                    border: 1px solid rgba(0, 0, 0, 0.04);
                    border-radius: 0.75rem;
                    overflow: hidden;
                }

                .card-hover:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.05);
                    border-color: rgba(99, 102, 241, 0.2);
                }

                .card-hover .text-muted {
                    transition: color 0.2s ease;
                }

                .card-hover:hover .text-muted {
                    color: #4f46e5 !important;
                }
                </style>
            </div>
            
            <!-- Document Statistics -->
            <div class="card document-info-card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i>
                    <span>{% trans 'معلومات المستند' %}</span>
                </div>
                <div class="card-body">
                    <div class="info-item">
                        <i class="fas fa-eye"></i>
                        <div class="d-flex justify-content-between w-100">
                            <span>{% trans 'عدد المشاهدات' %}</span>
                            <span class="fw-medium">{{ document.view_count|default:0 }}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-download"></i>
                        <div class="d-flex justify-content-between w-100">
                            <span>{% trans 'عدد مرات التحميل' %}</span>
                            <span class="fw-medium">{{ document.download_count|default:0 }}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-calendar-check"></i>
                        <div class="d-flex justify-content-between w-100">
                            <span>{% trans 'تاريخ الإنشاء' %}</span>
                            <span class="fw-medium">{{ document.created_at|date:"Y/m/d" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Document Actions -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-3 fw-semibold text-gray-800">
                        <i class="fas fa-link text-primary me-2"></i>
                        {% trans 'مستندات ذات صلة' %}
                    </h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'pdf_reader:document_upload' %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-upload me-2"></i> {% trans 'رفع مستند جديد' %}
                    </a>
                    <a href="{% url 'pdf_reader:document_download' document.pk %}" class="list-group-item list-group-item-action">
                        <i class="fas fa-download me-2"></i> {% trans 'تحميل هذا الملف' %}
                    </a>
                    {% if document.uploaded_by == request.user or request.user.is_staff %}
                        <a href="{% url 'pdf_reader:document_update' document.pk %}" class="list-group-item list-group-item-action">
                            <i class="fas fa-edit me-2"></i> {% trans 'تعديل تفاصيل الملف' %}
                        </a>
                    {% endif %}
                    {% if document.is_pdf %}
                        <a href="{% url 'pdf_reader:document_view' document.pk %}" target="_blank" class="list-group-item list-group-item-action">
                            <i class="fas fa-external-link-alt me-2"></i> {% trans 'فتح في نافذة جديدة' %}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Load the PDF viewer script -->
<script src="{% static 'pdf_reader/js/pdf-viewer.js' %}"></script>

<script>
// Modern confirm dialog with SweetAlert2
function confirmDelete(element) {
    const message = '{% trans "هل أنت متأكد من أنك تريد حذف هذا المستند؟"|escapejs %}';
    const confirmText = '{% trans "نعم، احذف"|escapejs %}';
    const cancelText = '{% trans "إلغاء"|escapejs %}';
    
    Swal.fire({
        title: '{% trans "تأكيد الحذف"|escapejs %}',
        text: message,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: confirmText,
        cancelButtonText: cancelText,
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            // If confirmed, submit the form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = element.href;
            
            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrfmiddlewaretoken';
                input.value = csrfToken.value;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    });
    
    // Prevent default action
    return false;
}

// Copy to clipboard function
function copyToClipboard(text, element) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const originalText = element.innerHTML;
        element.innerHTML = '<i class="fas fa-check"></i> {% trans "تم النسخ" %}';
        element.classList.add('text-success');
        
        // Revert after 2 seconds
        setTimeout(function() {
            element.innerHTML = originalText;
            element.classList.remove('text-success');
        }, 2000);
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
    });
}

// Initialize tooltips
$(function () {
    $('[data-toggle="tooltip"]').tooltip();
});
</script>

<!-- SweetAlert2 for beautiful alerts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Initialize animations -->
<script>
// Animate elements on scroll
function animateOnScroll() {
    const elements = document.querySelectorAll('.animate-on-scroll');
    elements.forEach(element => {
        const elementTop = element.getBoundingClientRect().top;
        const windowHeight = window.innerHeight;
        
        if (elementTop < windowHeight - 100) {
            element.classList.add('animate__animated', 'animate__fadeInUp');
        }
    });
}

// Run animations on load and scroll
window.addEventListener('load', animateOnScroll);
window.addEventListener('scroll', animateOnScroll);
</script>

<!-- Keep existing scripts -->

// Modern confirm dialog with SweetAlert2
function confirmDelete(element) {
    const message = '{% trans "هل أنت متأكد من أنك تريد حذف هذا المستند؟"|escapejs %}';
    const confirmText = '{% trans "نعم، احذف"|escapejs %}';
    const cancelText = '{% trans "إلغاء"|escapejs %}';
    
    Swal.fire({
        title: '{% trans "تأكيد الحذف"|escapejs %}',
        text: message,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: confirmText,
        cancelButtonText: cancelText,
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = element.dataset.deleteUrl;
        }
    });
    
    return false;
}

// Copy to clipboard function
function copyToClipboard(text, element) {
    navigator.clipboard.writeText(text).then(() => {
        const originalText = element.innerHTML;
        element.innerHTML = '<i class="fas fa-check"></i> {% trans "تم النسخ"|escapejs %}';
        element.classList.add('text-success');
        
        setTimeout(() => {
            element.innerHTML = originalText;
            element.classList.remove('text-success');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}
</script>

<!-- SweetAlert2 for beautiful alerts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Animate.css for smooth animations -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

<!-- PDF.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
<script>
// Add smooth scrolling to all links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Initialize tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Initialize PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

// Add animation on scroll
function animateOnScroll() {
    const elements = document.querySelectorAll('.animate-on-scroll');
    elements.forEach(element => {
        const elementTop = element.getBoundingClientRect().top;
        const windowHeight = window.innerHeight;
        if (elementTop < windowHeight - 100) {
            element.classList.add('animate__animated', 'animate__fadeInUp');
        }
    });
}

// Run animations on load and scroll
window.addEventListener('load', animateOnScroll);
window.addEventListener('scroll', animateOnScroll);

// Document viewer module
const DocumentViewer = (function() {
    // Elements
    let pdfViewerContainer, pdfViewer, pdfIframe, loadingMessage, errorMessage, errorText, retryBtn, debugBtn;
    
    // State
    let isInitialized = false;
    let loadTimeout = null;
    // Initialize debug info with document data
    let debugInfo = (function() {
        try {
            return {
                documentId: '{{ document.id|escapejs }}',
                documentTitle: '{{ document.title|escapejs }}',
                documentUrl: '{{ document.file.url|default:""|escapejs }}',
                documentSize: '{{ document.file.size|filesizeformat|default:"غير معروف"|escapejs }}',
                documentType: '{{ document.get_file_type_display|default:"غير معروف"|escapejs }}',
                isPublic: '{{ document.is_public|yesno:"true,false" }}' === 'true',
                uploadedBy: '{{ document.uploaded_by.get_full_name|default:document.uploaded_by.username|default:"غير معروف"|escapejs }}',
                uploadedAt: '{{ document.uploaded_at|date:"Y-m-d H:i"|default:"غير معروف"|escapejs }}',
                lastViewed: '{{ document.last_viewed|date:"Y-m-d H:i"|default:"غير معروف"|escapejs }}',
                viewCount: parseInt('{{ document.view_count|default:0 }}', 10) || 0,
                debugMode: false
            };
        } catch (e) {
            console.error('Error initializing debug info:', e);
            return {
                documentId: '',
                documentTitle: '',
                documentUrl: '',
                documentSize: '',
                documentType: '',
                isPublic: false,
                uploadedBy: '',
                uploadedAt: '',
                lastViewed: '',
                viewCount: 0,
                debugMode: false
            };
        }
    })();
    
    // Initialize the module
    function init() {
        // Get DOM elements
        pdfViewerContainer = document.getElementById('pdf-viewer-container');
        pdfViewer = document.getElementById('pdf-viewer');
        pdfIframe = document.getElementById('pdf-iframe');
        loadingMessage = document.getElementById('loading-message');
        errorMessage = document.getElementById('error-message');
        errorText = document.getElementById('error-text');
        retryBtn = document.getElementById('retry-btn');
        debugBtn = document.getElementById('debug-btn');
        
        // Check if we have all required elements
        if (!pdfViewerContainer || !pdfViewer || !pdfIframe || !loadingMessage || !errorMessage || !errorText) {
            console.error('Required elements not found');
            return;
        }
        
        // Set up event listeners
        if (retryBtn) {
            retryBtn.addEventListener('click', reloadPdfViewer);
        }
        
        // Set up debug button
        if (debugBtn) {
            debugBtn.addEventListener('click', function() {
                debugInfo.debugMode = !debugInfo.debugMode;
                console.log('Debug Info:', debugInfo);
                
                // Toggle debug info display
                if (debugInfo.debugMode) {
                    const debugMessage = [
                        'معلومات التصحيح:',
                        `- معرف المستند: ${debugInfo.documentId}`,
                        `- العنوان: ${debugInfo.documentTitle}`,
                        `- الرابط: ${debugInfo.documentUrl}`,
                        `- الحجم: ${debugInfo.documentSize}`,
                        `- النوع: ${debugInfo.documentType}`,
                        `- عام: ${debugInfo.isPublic ? 'نعم' : 'لا'}`,
                        `- تم الرفع بواسطة: ${debugInfo.uploadedBy || 'غير معروف'}`,
                        `- تاريخ الرفع: ${debugInfo.uploadedAt || 'غير معروف'}`,
                        `- آخر مشاهدة: ${debugInfo.lastViewed || 'غير معروف'}`,
                        `- عدد المشاهدات: ${debugInfo.viewCount || '0'}`
                    ].join('\n');
                    
                    alert(debugMessage);
                }
            });
        }
        
        // Update view count when the page loads
        if (debugInfo.documentId) {
            const viewCountUrl = `{% url 'pdf_reader:document_view' document.pk %}`;
            fetch(viewCountUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin'
            }).catch(error => {
                console.error('Error updating view count:', error);
            });
        }
        
        // Initialize the viewer
        initPdfViewer();
    }
    
    // Show loading state
    function showLoading() {
        if (loadingMessage) loadingMessage.style.display = 'flex';
        if (errorMessage) errorMessage.style.display = 'none';
        if (pdfViewer) pdfViewer.style.display = 'none';
    }
    
    // Show error state
    function showError(message) {
        console.error('PDF Viewer Error:', message);
        if (errorText) errorText.textContent = message || 'حدث خطأ غير معروف';
        if (errorMessage) errorMessage.style.display = 'block';
        if (loadingMessage) loadingMessage.style.display = 'none';
        if (pdfViewer) pdfViewer.style.display = 'none';
        clearTimeout(loadTimeout);
    }
    
    // Show PDF viewer
    function showPdfViewer() {
        if (loadingMessage) loadingMessage.style.display = 'none';
        if (errorMessage) errorMessage.style.display = 'none';
        if (pdfViewer) pdfViewer.style.display = 'block';
        clearTimeout(loadTimeout);
    }
    
    // Reload the PDF viewer
    function reloadPdfViewer(e) {
        if (e) e.preventDefault();
        
        if (!pdfIframe) {
            showError('عنصر المعاينة غير موجود');
            return;
        }
        
        // Reset state
        isInitialized = false;
        
        // Show loading state
        showLoading();
        
        // Force reload the iframe with cache busting
        const currentSrc = pdfIframe.src.split('?')[0];
        pdfIframe.src = currentSrc + (currentSrc.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
        
        // Re-initialize the viewer
        initPdfViewer();
    }
    
    // Initialize the PDF viewer
    function initPdfViewer() {
        // Skip if already initialized or if we're in the middle of loading
        if (isInitialized || !pdfIframe || window.isPdfLoading) return;
        
        isInitialized = true;
        window.isPdfLoading = true;
        showLoading();
        
        // Set a timeout for loading
        clearTimeout(loadTimeout);
        loadTimeout = setTimeout(function() {
            if (loadingMessage && loadingMessage.style.display === 'flex') {
                console.warn('PDF loading timed out');
                showError('استغرقت عملية التحميل وقتاً طويلاً. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                window.isPdfLoading = false;
            }
        }, 30000); // 30 seconds timeout
        
        // Set up event listeners
        function handleLoad() {
            clearTimeout(loadTimeout);
            window.isPdfLoading = false;
            showPdfViewer();
            
            // Remove the event listener to prevent memory leaks
            pdfIframe.removeEventListener('load', handleLoad);
            pdfIframe.removeEventListener('error', handleError);
        }
        
        function handleError() {
            clearTimeout(loadTimeout);
            window.isPdfLoading = false;
            showError('حدث خطأ أثناء تحميل المستند. يرجى المحاولة مرة أخرى.');
            
            // Remove the event listener to prevent memory leaks
            pdfIframe.removeEventListener('load', handleLoad);
            pdfIframe.removeEventListener('error', handleError);
        }
        
        // Use addEventListener instead of onload/onerror to allow multiple listeners
        pdfIframe.addEventListener('load', handleLoad);
        pdfIframe.addEventListener('error', handleError);
        
        // Set the source with cache busting
        const currentSrc = pdfIframe.src.split('?')[0];
        const newSrc = currentSrc + (currentSrc.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
        console.log('Loading PDF in iframe:', newSrc);
        pdfIframe.src = newSrc;
    }
    
    // Public API
    return {
        init: init,
        reload: reloadPdfViewer
    };
})();

// Main document ready handler
(function() {
    'use strict';
    
    // Initialize the document viewer with progress tracking
    function initDocumentViewer() {
        // Use a different variable name to avoid conflict
        const docViewer = DocumentViewer && DocumentViewer.init ? DocumentViewer.init() : null;
        let progressInterval;
        let loadTimeout;
        
        // Simulate progress with more realistic timing
        let progress = 0;
        let lastUpdate = Date.now();
        
        progressInterval = setInterval(() => {
            if (progress < 90) {
                const now = Date.now();
                const delta = now - lastUpdate;
                lastUpdate = now;
                
                // Faster progress at the beginning, slower towards the end
                const progressStep = (100 - progress) * 0.05 + 0.5;
                progress = Math.min(90, progress + progressStep);
                
                updateProgress(progress);
                updateTimeRemaining(progress);
            }
        }, 200);
        
        // Update progress bar and text
        function updateProgress(value) {
            const progressBar = document.querySelector('.progress-bar');
            const progressText = document.querySelector('.progress-text');
            const statusText = document.querySelector('.status-text');
            const progressPercentage = document.querySelector('.progress-percentage');
            
            // Define loading stages with different status messages
            const loadingStages = [
                { threshold: 0, status: '{% trans "جاري تهيئة المعاينة..." %}' },
                { threshold: 10, status: '{% trans "جاري تحميل البيانات..." %}' },
                { threshold: 25, status: '{% trans "جاري تحميل الصفحات..." %}' },
                { threshold: 40, status: '{% trans "جاري معالجة الصور..." %}' },
                { threshold: 60, status: '{% trans "جاري معالجة الخطوط..." %}' },
                { threshold: 75, status: '{% trans "جاري تحضير المعاينة..." %}' },
                { threshold: 85, status: '{% trans "جاري التجهيز للعرض..." %}' },
            ];
            
            const loadingTips = [
                '{% trans "يمكنك تصفح المستندات الأخرى أثناء الانتظار" %}',
                '{% trans "جودة العرض تعتمد على سرعة اتصالك بالإنترنت" %}',
                '{% trans "يمكنك تكبير وتصغير الصفحة بعد التحميل" %}',
                '{% trans "اضغط على زر التحميل لحفظ نسخة من الملف" %}',
                '{% trans "استخدم أزرار التنقل للانتقال بين الصفحات" %}',
            ];
            
            // Update progress bar
            if (progressBar) {
                progressBar.style.width = `${value}%`;
                progressBar.setAttribute('aria-valuenow', value);
                
                // Update progress percentage bubble
                if (progressPercentage) {
                    progressPercentage.textContent = `${Math.round(value)}%`;
                    progressPercentage.style.right = `calc(${100 - value}% - 15px)`;
                }
            }
            
            // Update progress text
            if (progressText) {
                progressText.textContent = `${Math.round(value)}% {% trans 'مكتمل' %}`;
            }
            
            // Update status text based on progress
            if (statusText) {
                // Find the highest threshold we've passed
                const currentStage = [...loadingStages].reverse().find(stage => value >= stage.threshold);
                if (currentStage) {
                    statusText.textContent = currentStage.status;
                }
                
                // Random tip every 15%
                if (value % 15 === 0 && value < 90) {
                    const tipElement = document.getElementById('loading-tip');
                    if (tipElement) {
                        const randomTip = loadingTips[Math.floor(Math.random() * loadingTips.length)];
                        tipElement.textContent = randomTip;
                        
                        // Add animation
                        tipElement.classList.remove('animate__animated', 'animate__fadeIn');
                        void tipElement.offsetWidth; // Trigger reflow
                        tipElement.classList.add('animate__animated', 'animate__fadeIn');
                    }
                }
            }
            
            // Add pulse animation when reaching certain milestones
            if ([25, 50, 75, 90].includes(Math.round(value))) {
                const icon = document.querySelector('.document-icon-container i');
                if (icon) {
                    icon.classList.add('animate__animated', 'animate__pulse');
                    setTimeout(() => {
                        icon.classList.remove('animate__animated', 'animate__pulse');
                    }, 1000);
                }
            }
        }
        
        function updateTimeRemaining(progress) {
            const timeRemainingElement = document.getElementById('time-remaining');
            if (!timeRemainingElement) return;
            
            // Simple time remaining estimation
            let remainingTime;
            if (progress < 20) {
                remainingTime = '{% trans "أقل من دقيقة" %}';
            } else if (progress < 50) {
                remainingTime = '{% trans "بضع ثوانٍ" %}';
            } else if (progress < 80) {
                remainingTime = '{% trans "لحظات قليلة" %}';
            } else {
                remainingTime = '{% trans "تقريباً انتهى" %}';
            }
            timeRemainingElement.textContent = remainingTime;
        }
        
        // This code has been moved to the external PDF viewer file
                // Configuration
                const config = {
                    container: '#pdf-viewer-container',
                    canvas: '#pdf-canvas',
                    pageNumEl: '#page-num',
                    pageCountEl: '#page-count',
                    prevBtn: '#prev-page',
                    nextBtn: '#next-page',
                    zoomInBtn: '#zoom-in',
                    zoomOutBtn: '#zoom-out',
                    zoomLevelEl: '#zoom-level',
                    fitWidthBtn: '#fit-width',
                    fitPageBtn: '#fit-page',
                    retryBtn: '#retry-btn',
                    loadingEl: '#loading-message',
                    errorEl: '#error-message',
                    errorTextEl: '#error-text',
                    defaultScale: 1.0,
                    maxScale: 3.0,
                    minScale: 0.3,
                    scaleStep: 0.1,
                    rtl: true,
                    showPageNumbers: true,
                    showZoomControls: true,
                    onDocumentLoad: function() {
                        console.log('Document loaded');
                        const loadingEl = document.getElementById('loading-message');
                        if (loadingEl) {
                            loadingEl.style.opacity = '0';
                            setTimeout(() => {
                                loadingEl.style.display = 'none';
                                const pdfViewer = document.getElementById('pdf-viewer');
                                if (pdfViewer) pdfViewer.style.display = 'flex';
                                
                                // Dispatch custom event when PDF is fully loaded
                                const event = new Event('pdfViewerReady');
                                document.dispatchEvent(event);
                            }, 300);
                        }
                        // Clear any existing timeouts to prevent multiple loads
                        if (window.pdfLoadTimeout) {
                            clearTimeout(window.pdfLoadTimeout);
                            window.pdfLoadTimeout = null;
                        }
                    },
                    onPageChange: function(pageNum, pageCount) {
                        console.log(`Page ${pageNum} of ${pageCount}`);
                    },
                    onZoomChange: function(scale) {
                        console.log(`Zoom: ${Math.round(scale * 100)}%`);
                    },
                    onError: function(error) {
                        console.error('PDF error:', error);
                        const errorEl = document.getElementById('error-message');
                        const errorTextEl = document.getElementById('error-text');
                        if (errorEl && errorTextEl) {
                            let errorMessage = 'حدث خطأ أثناء تحميل المستند';
                            if (error && error.message) {
                                errorMessage += `: ${error.message}`;
                                if (error.message.includes('Failed to fetch')) {
                                    errorMessage = 'تعذر الاتصال بالخادم. يرجى التحقق من اتصال الشبكة والمحاولة مرة أخرى.';
                                } else if (error.message.includes('Invalid PDF structure')) {
                                    errorMessage = 'ملف PDF تالف أو غير صالح.';
                                }
                            }
                            errorTextEl.textContent = errorMessage;
                            errorEl.classList.remove('hidden');
                            
                            // Show the error message for at least 5 seconds
                            setTimeout(() => {
                                if (errorEl) {
                                    errorEl.classList.add('hidden');
                                }
                            }, 5000);
                        }
                    }
                };

                // Initialize the PDF viewer
                const pdfViewer = new PDFViewer(config);
                
                // Store the viewer instance globally for debugging
                window.pdfViewerInstance = pdfViewer;
                
                // Get the PDF URL using the document's download URL
                const pdfUrl = '{% url "pdf_reader:document_download" document.pk %}';
                const cacheBustedUrl = pdfUrl + '?t=' + new Date().getTime();
                
                console.log('PDF URL:', pdfUrl);
                console.log('Cache-busted URL:', cacheBustedUrl);
                
                // Try loading the PDF
                try {
                    console.log('Attempting to load PDF...');
                    // Add authentication headers if needed
                    const headers = {};
                    {% if request.user.is_authenticated %}
                    headers['X-CSRFToken'] = '{{ csrf_token }}';
                    {% endif %}
                    
                    // Pass headers as part of the options object
                    const options = { headers: headers };
                    pdfViewer.load(cacheBustedUrl, options);
                } catch (error) {
                    console.error('Failed to load PDF:', error);
                    const errorEl = document.getElementById('error-message');
                    const errorTextEl = document.getElementById('error-text');
                    if (errorEl && errorTextEl) {
                        errorTextEl.textContent = 'فشل تحميل الملف. يرجى التأكد من صحة الرابط.';
                        errorEl.classList.remove('hidden');
                    }
                }
                
                // Handle window resize with debounce
                let resizeTimer;
                window.addEventListener('resize', function() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(function() {
                        if (pdfViewer && typeof pdfViewer.resize === 'function') {
                            pdfViewer.resize();
                        }
                    }, 250);
                });
                
                // Handle retry button
                const retryBtn = document.getElementById('retry-btn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', function() {
                        const errorEl = document.getElementById('error-message');
                        if (errorEl) errorEl.classList.add('hidden');
                        viewer.load('{{ document.file.url }}');
                    });
                }
                
                // Keyboard navigation
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowLeft' && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        if (pdfViewer && typeof pdfViewer.nextPage === 'function') {
                            pdfViewer.nextPage();
                        }
                    } else if (e.key === 'ArrowRight' && !e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        if (pdfViewer && typeof pdfViewer.prevPage === 'function') {
                            pdfViewer.prevPage();
                        }
                    } else if ((e.key === '+' || e.key === '=') && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        if (pdfViewer && typeof pdfViewer.zoomIn === 'function') {
                            pdfViewer.zoomIn();
                        }
                    } else if ((e.key === '-' || e.key === '_') && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        if (pdfViewer && typeof pdfViewer.zoomOut === 'function') {
                            pdfViewer.zoomOut();
                        }
                    } else if (e.key === '0' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        if (pdfViewer && typeof pdfViewer.setScale === 'function') {
                            pdfViewer.setScale(1.0);
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error initializing PDF viewer:', error);
                const errorEl = document.getElementById('error-message') || 
                    document.createElement('div');
                errorEl.textContent = 'Failed to initialize PDF viewer. Please try again.';
                errorEl.classList.add('alert', 'alert-danger', 'm-3');
                document.body.appendChild(errorEl);
            }
        };
        
        // Add click animation to buttons
        document.querySelectorAll('.btn').forEach(function(button) {
            button.addEventListener('click', function() {
                this.classList.add('active');
                const self = this;
                setTimeout(function() {
                    self.classList.remove('active');
                }, 150);
            });
        });
        
        // Add hover effect to cards
        document.querySelectorAll('.card').forEach(function(card) {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                card.style.setProperty('--mouse-x', `${x}px`);
                card.style.setProperty('--mouse-y', `${y}px`);
            });
        });
        
        // Add loading state to forms
        const formElements = document.querySelectorAll('form');
        formElements.forEach(form => {
            form.addEventListener('submit', function() {
                const submitButton = this.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> جاري المعالجة...';
                }
            });
        });
        
        // Format file size
        function formatFileSize(bytes, decimals = 2) {
    if (bytes === 0) return '0 بايت';
    
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['بايت', 'كيلوبايت', 'ميجابايت', 'جيجابايت', 'تيرابايت'];
    
    const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        // Initialize the viewer with progress tracking
        function initializeViewer() {
            console.log('Page fully loaded, initializing viewer...');
            
            // Initialize progress tracking
            let progress = 0;
            let lastUpdate = Date.now();
            let progressInterval;
            
            // Update progress function
            const updateProgress = () => {
                if (progress < 90) {
                    const now = Date.now();
                    const delta = now - lastUpdate;
                    lastUpdate = now;
                    
                    // Slower progress at the beginning, faster in the middle, then slow down at the end
                    let increment;
                    if (progress < 30) {
                        increment = 0.5 + Math.random() * 1.5; // 0.5-2%
                    } else if (progress < 70) {
                        increment = 1.5 + Math.random() * 3;   // 1.5-4.5%
                    } else {
                        increment = 0.5 + Math.random() * 1;   // 0.5-1.5%
                    }
                    
                    // Adjust speed based on time since last update
                    increment = increment * (delta / 200);
                    progress = Math.min(90, progress + increment);
                    
                    // Update progress display
                    updateProgressDisplay(progress);
                } else {
                    clearInterval(progressInterval);
                }
            };
            
            // Start progress updates
            progressInterval = setInterval(updateProgress, 100);
            
            try {
                const fileUrl = '{{ document.file.url|lower }}';
                if (!fileUrl.endsWith('.pdf')) {
                    console.log('Not a PDF file, showing download option');
                    clearInterval(progressInterval);
                    showPdfViewer();
                    return;
                }
                
                // Small delay to ensure all elements are ready
                setTimeout(() => {
                    clearInterval(progressInterval);
                    initPdfViewer();
                }, 500);
            } catch (error) {
                console.error('Error initializing viewer:', error);
                clearInterval(progressInterval);
                showError('حدث خطأ أثناء تهيئة عارض المستندات');
            }
        }
        
        // Update progress display
        function updateProgressDisplay(progress) {
            const progressBar = document.getElementById('loading-progress');
            const progressText = document.getElementById('loading-progress-text');
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.textContent = `${Math.round(progress)}%`;
        }
    }
    
    // Global progress update function
    function updateProgress(value) {
        const progressBar = document.getElementById('loading-progress');
        const progressText = document.getElementById('progress-text');
        const statusText = document.getElementById('status-text');
        const progressPercentage = document.querySelector('#loading-progress span');
        
        const loadingStages = [
            { threshold: 0, status: '{% trans "جاري فحص الملف..." %}' },
            { threshold: 10, status: '{% trans "جاري معالجة المستند..." %}' },
            { threshold: 25, status: '{% trans "جاري تحميل الصفحات..." %}' },
            { threshold: 40, status: '{% trans "جاري معالجة الصور..." %}' },
            { threshold: 60, status: '{% trans "جاري معالجة الخطوط..." %}' },
            { threshold: 75, status: '{% trans "جاري تحضير المعاينة..." %}' },
            { threshold: 85, status: '{% trans "جاري التجهيز للعرض..." %}' },
        ];
        
        const loadingTips = [
            '{% trans "يمكنك تصفح المستندات الأخرى أثناء الانتظار" %}',
            '{% trans "جودة العرض تعتمد على سرعة اتصالك بالإنترنت" %}',
            '{% trans "يمكنك تكبير وتصغير الصفحة بعد التحميل" %}',
            '{% trans "اضغط على زر التحميل لحفظ نسخة من الملف" %}',
            '{% trans "استخدم أزرار التنقل للانتقال بين الصفحات" %}',
        ];
        
        // Update progress bar
        if (progressBar) {
            progressBar.style.width = `${value}%`;
            progressBar.setAttribute('aria-valuenow', value);
            
            // Update progress percentage bubble
            if (progressPercentage) {
                progressPercentage.textContent = `${Math.round(value)}%`;
                progressPercentage.style.right = `calc(${100 - value}% - 15px)`;
            }
        }
        
        // Update progress text
        if (progressText) {
            progressText.textContent = `${Math.round(value)}% {% trans 'مكتمل' %}`;
        }
        
        // Update status text based on progress
        if (statusText) {
            // Find the highest threshold we've passed
            const currentStage = [...loadingStages].reverse().find(stage => value >= stage.threshold);
            if (currentStage) {
                statusText.textContent = currentStage.status;
            }
            
            // Random tip every 15%
            if (value % 15 === 0 && value < 90) {
                const tipElement = document.getElementById('loading-tip');
                if (tipElement) {
                    const randomTip = loadingTips[Math.floor(Math.random() * loadingTips.length)];
                    tipElement.textContent = randomTip;
                    
                    // Add animation
                    tipElement.classList.remove('animate__animated', 'animate__fadeIn');
                    void tipElement.offsetWidth; // Trigger reflow
                    tipElement.classList.add('animate__animated', 'animate__fadeIn');
                }
            }
        }
        
        // Add pulse animation when reaching certain milestones
        if ([25, 50, 75, 90].includes(Math.round(value))) {
            const icon = document.querySelector('.document-icon-container i');
            if (icon) {
                icon.classList.add('animate__animated', 'animate__pulse');
                setTimeout(() => {
                    icon.classList.remove('animate__animated', 'animate__pulse');
                }, 1000);
            }
        }
    }
    
    function updateTimeRemaining(progress) {
        const timeRemainingElement = document.getElementById('time-remaining');
        if (!timeRemainingElement) return;
        
        // Simple time remaining estimation
        let remainingTime;
        if (progress < 20) {
            remainingTime = '{% trans "أقل من دقيقة" %}';
        } else if (progress < 50) {
            remainingTime = '{% trans "بضع ثوانٍ" %}';
        } else if (progress < 80) {
            remainingTime = '{% trans "لحظات قليلة" %}';
        } else {
            remainingTime = '{% trans "جاري الانتهاء..." %}';
        }
        
        timeRemainingElement.textContent = remainingTime;
    }
    
    // Clean up interval when document is loaded
    function handlePdfLoaded() {
        clearInterval(progressInterval);
        updateProgress(100);
        
        // Smooth transition out
        setTimeout(() => {
            const loadingContainer = document.getElementById('loading-message');
            if (loadingContainer) {
                loadingContainer.style.opacity = '0';
                setTimeout(() => {
                    loadingContainer.style.display = 'none';
                }, 500);
            }
        }, 500);
    }
    
    // Add event listener for PDF loaded
    document.addEventListener('pdfLoaded', handlePdfLoaded);
    
    // Initialize the viewer when the page loads
    function initializePage() {
        if (typeof initializeViewer === 'function') {
            initializeViewer();
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }
    
    // Add click animation to buttons
    document.querySelectorAll('.btn').forEach(button => {
        button.addEventListener('click', function() {
            this.classList.add('active');
            setTimeout(() => this.classList.remove('active'), 150);
        });
    });
    
    // Add hover effect to cards
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        card.addEventListener('mousemove', (e) => {
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            card.style.setProperty('--mouse-x', `${x}px`);
            card.style.setProperty('--mouse-y', `${y}px`);
        });
    });
    
    // Add loading state to forms
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> جاري المعالجة...';
            }
        });
    });
    
    // Initialize the document viewer when the DOM is fully loaded
    function initializeDocumentViewer() {
        // Clean up any existing event listeners
        document.removeEventListener('DOMContentLoaded', initializeDocumentViewer);
        
        // Initialize the document viewer
        if (typeof initDocumentViewer === 'function') {
            initDocumentViewer();
        }
    }
    
    // Clean up event listeners when the page unloads
    function cleanupBeforeUnload() {
        // Clear any intervals or timeouts
        if (typeof progressInterval !== 'undefined') {
            clearInterval(progressInterval);
        }
        if (typeof loadTimeout !== 'undefined') {
            clearTimeout(loadTimeout);
        }
        
        // Remove event listeners
        if (typeof handlePdfLoaded === 'function') {
            document.removeEventListener('pdfLoaded', handlePdfLoaded);
        }
        document.removeEventListener('DOMContentLoaded', initializePage);
        document.removeEventListener('DOMContentLoaded', initializeDocumentViewer);
        window.removeEventListener('beforeunload', cleanupBeforeUnload);
    }
    
    // Set up the initial load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDocumentViewer);
    } else {
        // Use setTimeout to ensure the DOM is fully loaded
        setTimeout(initializeDocumentViewer, 0);
    }
    
    // Single beforeunload event listener
    window.addEventListener('beforeunload', cleanupBeforeUnload);
})();
</script>
{% endblock %}
